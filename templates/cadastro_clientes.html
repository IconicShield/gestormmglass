{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Cadastro de Clientes</h1>
    <div>
        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#importarClientesModal">
            <i class="fas fa-file-upload"></i> Importar .xlsx
        </button>
        <a href="{{ url_for('exportar_clientes') }}" class="btn btn-success">
            <i class="fas fa-file-excel"></i> Exportar .xlsx
        </a>
        <a href="{{ url_for('novo_cliente', tipo='rapido') }}" class="btn btn-primary"><i class="fas fa-plus fa-sm"></i> Novo Cadastro</a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h6 class="mb-0">Clientes Cadastrados</h6>
    </div>
    <div class="card-body">
        <!-- Formulário de Filtros -->
        <form method="GET" class="mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="search_name">Buscar por Nome:</label>
                        <input type="text" class="form-control" id="search_name" name="search_name" 
                               value="{{ search_name }}" placeholder="Digite o nome do cliente">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter_tipo_pessoa">Tipo de Pessoa:</label>
                        <select class="form-control" id="filter_tipo_pessoa" name="filter_tipo_pessoa">
                            <option value="">Todos</option>
                            <option value="Física" {{ 'selected' if filter_tipo_pessoa == 'Física' }}>Física</option>
                            <option value="Jurídica" {{ 'selected' if filter_tipo_pessoa == 'Jurídica' }}>Jurídica</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_cpf_cnpj">CPF/CNPJ:</label>
                        <input type="text" class="form-control" id="search_cpf_cnpj" name="search_cpf_cnpj" 
                               value="{{ search_cpf_cnpj }}" placeholder="Digite CPF ou CNPJ">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <a href="{{ url_for('cadastro_clientes') }}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times"></i> Limpar Filtros
                    </a>
                </div>
            </div>
        </form>
        
        <!-- Botões de ação em lote para Clientes -->
        <div class="mb-3" id="clientes-bulk-actions" style="display: none;">
            <div class="d-flex align-items-center">
                <span class="mr-3 text-muted"><span id="clientes-selected-count">0</span> cliente(s) selecionado(s)</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="bulkDeleteClientes()">
                    <i class="fas fa-trash-alt"></i> Excluir Selecionados
                </button>
            </div>
        </div>
        
        <!-- Informações da paginação -->
        <div class="mb-3">
            <small class="text-muted">
                Mostrando {{ ((clientes.page - 1) * clientes.per_page) + 1 }} a 
                {{ clientes.page * clientes.per_page if clientes.page * clientes.per_page <= clientes.total else clientes.total }} 
                de {{ clientes.total }} cliente(s) cadastrado(s)
                {% if search_name or filter_tipo_pessoa or search_cpf_cnpj %}
                    <span class="badge badge-info">Filtros aplicados</span>
                {% endif %}
            </small>
        </div>
        
        <table class="table table-hover table-sm table-uppercase">
            <thead class="thead-light">
                <tr>
                    <th width="30">
                        <input type="checkbox" id="select-all-clientes" onchange="toggleAllClientes(this)">
                    </th>
                    <th>N°</th>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Pessoa</th>
                    <th>CPF/CNPJ</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes.items %}
                <tr>
                    <td>
                        <input type="checkbox" class="cliente-checkbox" value="{{ cliente.id }}" onchange="updateClientesBulkActions()">
                    </td>
                    <td>{{ cliente.numero_cliente }}</td>
                    <td>
                        <button type="button" class="btn btn-link text-uppercase" data-toggle="modal" data-target="#detalhesCliente-{{ cliente.id }}" style="color: var(--text-color);">
                            {{ cliente.nome }}
                        </button>
                    </td>
                    <td>{{ cliente.telefone or '-' }}</td>
                    <td>{{ cliente.tipo_pessoa }}</td>
                    <td>{{ cliente.cpf_cnpj or '-' }}</td>
                    <td>
                        <a href="{{ url_for('editar_cliente', id=cliente.id) }}" class="btn btn-sm btn-info" title="Editar Cliente"><i class="fas fa-edit"></i></a>
                        <form action="{{ url_for('excluir_cliente', id=cliente.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Tem a certeza que deseja excluir este cliente?');">
                            <button type="submit" class="btn btn-sm btn-danger" title="Excluir Cliente"><i class="fas fa-trash-alt"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">Nenhum cliente cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if clientes.pages > 1 %}
<nav aria-label="Navegação de páginas">
    <ul class="pagination justify-content-center">
        {% if clientes.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('cadastro_clientes', page=clientes.prev_num, search_name=search_name, filter_tipo_pessoa=filter_tipo_pessoa, search_cpf_cnpj=search_cpf_cnpj) }}" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
        {% endif %}
        
        {% for page_num in clientes.iter_pages() %}
            {% if page_num %}
                {% if page_num != clientes.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('cadastro_clientes', page=page_num, search_name=search_name, filter_tipo_pessoa=filter_tipo_pessoa, search_cpf_cnpj=search_cpf_cnpj) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">…</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if clientes.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('cadastro_clientes', page=clientes.next_num, search_name=search_name, filter_tipo_pessoa=filter_tipo_pessoa, search_cpf_cnpj=search_cpf_cnpj) }}" aria-label="Próximo">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block modals %}
    {% for cliente in clientes.items %}
    <div class="modal fade" id="detalhesCliente-{{ cliente.id }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel-{{ cliente.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel-{{ cliente.id }}">Detalhes de: {{ cliente.nome }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Dados Pessoais</h6><hr class="mt-1 mb-2">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">N° Cliente:</dt><dd class="col-sm-8">{{ cliente.numero_cliente }}</dd>
                                <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8">{{ cliente.nome }}</dd>
                                <dt class="col-sm-4">Telefone:</dt><dd class="col-sm-8">{{ cliente.telefone or '-' }}</dd>
                                <dt class="col-sm-4">Tipo Pessoa:</dt><dd class="col-sm-8">{{ cliente.tipo_pessoa }}</dd>
                                <dt class="col-sm-4">CPF/CNPJ:</dt><dd class="col-sm-8">{{ cliente.cpf_cnpj or '-' }}</dd>
                                <dt class="col-sm-4">Como Conheceu:</dt><dd class="col-sm-8">{{ cliente.como_conheceu or '-' }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>Endereço</h6><hr class="mt-1 mb-2">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Rua:</dt><dd class="col-sm-8">{{ cliente.rua or '-' }}</dd>
                                <dt class="col-sm-4">Número:</dt><dd class="col-sm-8">{{ cliente.numero_endereco or '-' }}</dd>
                                <dt class="col-sm-4">Complemento:</dt><dd class="col-sm-8">{{ cliente.complemento or '-' }}</dd>
                                <dt class="col-sm-4">Bairro:</dt><dd class="col-sm-8">{{ cliente.bairro or '-' }}</dd>
                                <dt class="col-sm-4">Cidade:</dt><dd class="col-sm-8">{{ cliente.cidade or '-' }}</dd>
                                <dt class="col-sm-4">UF:</dt><dd class="col-sm-8">{{ cliente.uf or '-' }}</dd>
                                <dt class="col-sm-4">CEP:</dt><dd class="col-sm-8">{{ cliente.cep or '-' }}</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Observações</h6><hr class="mt-1 mb-2">
                            <p style="white-space: pre-wrap;">{{ cliente.observacoes or 'Nenhuma observação.' }}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <a href="{{ url_for('editar_cliente', id=cliente.id) }}" class="btn btn-primary">Editar Cliente</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <div class="modal fade" id="importarClientesModal" tabindex="-1" role="dialog" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importarModalLabel">Importar Clientes de .xlsx</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{{ url_for('importar_clientes') }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <p>O seu ficheiro .xlsx deve ter as colunas na seguinte ordem, sem cabeçalho. O campo "Nome" é o único obrigatório.</p>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><b>A:</b> Nome (*)</li>
                            <li class="list-group-item"><b>B:</b> Telefone</li>
                            <li class="list-group-item"><b>C:</b> Tipo Pessoa (Física/Jurídica)</li>
                            <li class="list-group-item"><b>D:</b> CPF/CNPJ</li>
                            <li class="list-group-item"><b>E:</b> Como Conheceu</li>
                            <li class="list-group-item"><b>F:</b> Rua</li>
                            <li class="list-group-item"><b>G:</b> Número</li>
                            <li class="list-group-item"><b>H:</b> Complemento</li>
                            <li class="list-group-item"><b>I:</b> Bairro</li>
                            <li class="list-group-item"><b>J:</b> Cidade</li>
                            <li class="list-group-item"><b>K:</b> UF</li>
                            <li class="list-group-item"><b>L:</b> CEP</li>
                            <li class="list-group-item"><b>M:</b> Observações</li>
                        </ul>
                        <div class="form-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="xlsx_file" name="xlsx_file" accept=".xlsx" required>
                                <label class="custom-file-label" for="xlsx_file">Escolher ficheiro...</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block scripts %}
<script>
// Funções para seleção em massa de Clientes
function toggleAllClientes(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.cliente-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateClientesBulkActions();
}

function updateClientesBulkActions() {
    const checkboxes = document.querySelectorAll('.cliente-checkbox:checked');
    const bulkActions = document.getElementById('clientes-bulk-actions');
    const selectedCount = document.getElementById('clientes-selected-count');
    
    if (checkboxes.length > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = checkboxes.length;
    } else {
        bulkActions.style.display = 'none';
    }
    
    // Atualizar estado do "selecionar todos"
    const allCheckboxes = document.querySelectorAll('.cliente-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-clientes');
    selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
}

function bulkDeleteClientes() {
    const checkboxes = document.querySelectorAll('.cliente-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
        alert('Selecione pelo menos um cliente para excluir.');
        return;
    }
    
    if (confirm(`Deseja excluir permanentemente ${ids.length} cliente(s) selecionado(s)? Esta ação não pode ser desfeita.`)) {
        bulkActionClientes('delete', ids);
    }
}

// Função para executar ações em lote para clientes
function bulkActionClientes(action, ids) {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/bulk-action-clientes', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + response.message);
                }
            } else {
                alert('Erro ao processar a solicitação.');
            }
        }
    };
    
    xhr.send(JSON.stringify({
        action: action,
        ids: ids
    }));
}
</script>

<style>
    :root {
        --bg-primary: #2d3748;
        --bg-secondary: #2d3748;
        --border-color: #4a5568;
        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
        --hover-bg: #1a365d;
        --hover-border: #4299e1;
        --input-bg: #2d3748;
        --input-border: #4a5568;
        --input-text: #e2e8f0;
    }
    
    [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --border-color: #dee2e6;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --hover-bg: #e3f2fd;
        --hover-border: #007bff;
        --input-bg: #ffffff;
        --input-border: #ced4da;
        --input-text: #495057;
    }
    
    /* Estilos para campos de formulário */
    .form-control {
        background-color: var(--input-bg) !important;
        border-color: var(--input-border) !important;
        color: var(--input-text) !important;
    }
    
    .form-control:focus {
        background-color: var(--input-bg) !important;
        border-color: var(--hover-border) !important;
        color: var(--input-text) !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }
    
    [data-theme="light"] .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }
    
    .form-control::placeholder {
        color: var(--text-secondary) !important;
    }
    
    /* Labels */
    label {
        color: var(--text-primary) !important;
    }
    
    /* Cards */
    .card {
        background-color: var(--bg-primary) !important;
        border-color: var(--border-color) !important;
    }
    
    .card-header {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .card-body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    /* Tabelas */
    .table {
        color: var(--text-primary) !important;
    }
    
    .table th {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .table td {
        background-color: var(--bg-primary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: var(--bg-secondary) !important;
    }
    
    /* Modal */
    .modal-content {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-header {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-footer {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }
</style>

{% endblock %}