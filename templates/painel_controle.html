{% extends 'base.html' %}

{% block content %}
<style>
/* Animações para as notificações */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Garantir visibilidade dos checkboxes */
.pedido-checkbox, .orcamento-checkbox {
    width: 16px !important;
    height: 16px !important;
    opacity: 1 !important;
    visibility: visible !important;
    display: inline-block !important;
    position: relative !important;
    margin: 0 !important;
    cursor: pointer !important;
}

/* Estilo para a coluna do checkbox */
td:first-child {
    text-align: center;
    vertical-align: middle;
    width: 30px;
}

th:first-child {
    text-align: center;
    width: 30px;
}

/* Espaçamento moderno para botões de ação */
.d-flex.gap-1 > * {
    margin-right: 0.25rem;
}

.d-flex.gap-1 > *:last-child {
    margin-right: 0;
}

/* Larguras fixas para colunas das tabelas */
#pedidos-table, #orcamentos-table {
    table-layout: fixed;
    width: 100%;
    max-width: 100%;
}

.table-responsive {
    overflow-x: auto;
    max-width: 100%;
}

#pedidos-table th:nth-child(1), #orcamentos-table th:nth-child(1) { width: 3%; }   /* Checkbox */

/* Estilos para os cards de anexos no modal */
.anexo-card {
    border: 2px solid #dee2e6;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Estilos para o modo de edição */
.modal.edit-mode .relatorio-content {
    position: relative;
}

.modal.edit-mode .relatorio-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 123, 255, 0.05);
    border: 2px dashed rgba(0, 123, 255, 0.3);
    pointer-events: none;
    z-index: 1;
}

.editable-text-box {
    user-select: none;
    transition: all 0.2s ease;
}

.editable-text-box:hover {
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    transform: translateY(-1px);
}

.editable-text-box [contenteditable] {
    user-select: text;
}

.editable-text-box [contenteditable]:focus {
    background: rgba(255, 255, 255, 1);
    border-radius: 4px;
    padding: 2px;
}

.modal.edit-mode img {
    transition: all 0.2s ease;
}

.modal.edit-mode img:hover {
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    transform: translateY(-1px);
}

/* Estilos para redimensionamento de imagens */
.image-resize-container {
    pointer-events: none;
}

.image-resize-container .resize-handle {
    pointer-events: all;
}

.resize-handle {
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.resize-handle:hover {
    background: #0056b3 !important;
    transform: scale(1.2);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.modal.edit-mode .image-resize-container {
    display: block;
}

.modal:not(.edit-mode) .image-resize-container {
    display: none;
}

.anexo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.anexo-card.selected {
    border-color: #007bff;
    background-color: #f8f9ff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.2);
}

.anexo-preview {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px dashed #dee2e6;
}

.anexo-card .form-check-input:checked + .form-check-label .fa-check-circle {
    color: #28a745 !important;
}

/* Estilos para a caixa compacta de anexos */
.anexos-compact-box {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 32px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: var(--input-bg, #ffffff);
    color: var(--text-primary, #495057);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    font-size: 12px;
    gap: 4px;
}

.anexos-compact-box:hover {
    border-color: #007bff;
    background: var(--hover-bg, #e3f2fd);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,123,255,0.2);
}

.anexos-compact-box.anexos-empty {
    border-style: dashed;
    border-color: #6c757d;
    color: #6c757d;
}

.anexos-compact-box.anexos-empty:hover {
    border-color: #28a745;
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
}

.anexos-compact-box.drag-over {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    transform: scale(1.05);
}

.anexos-compact-box i {
    font-size: 14px;
}

.anexos-count {
    font-weight: bold;
    font-size: 11px;
    min-width: 12px;
    text-align: center;
}

/* Animação de upload */
.anexos-compact-box.uploading {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.1);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.anexo-card .form-check-input:not(:checked) + .form-check-label .fa-check-circle {
    color: #6c757d !important;
}

.anexo-info h6 {
    color: #495057;
    font-weight: 600;
}

/* Responsividade para dispositivos móveis */
@media (max-width: 768px) {
    .anexo-card .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 576px) {
    .anexo-card .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
#pedidos-table th:nth-child(2), #orcamentos-table th:nth-child(2) { width: 8%; }   /* Data */
#pedidos-table th:nth-child(3), #orcamentos-table th:nth-child(3) { width: 8%; }  /* N° Pedido */
#pedidos-table th:nth-child(4), #orcamentos-table th:nth-child(4) { width: 6%; }  /* N° Cliente */
#pedidos-table th:nth-child(5), #orcamentos-table th:nth-child(5) { width: 18%; }  /* Cliente */
#pedidos-table th:nth-child(6), #orcamentos-table th:nth-child(6) { width: 12%; }  /* Obra */
#pedidos-table th:nth-child(7), #orcamentos-table th:nth-child(7) { width: 9%; }  /* Status */
#pedidos-table th:nth-child(8), #orcamentos-table th:nth-child(8) { width: 19%; }  /* Descrição */
#pedidos-table th:nth-child(9), #orcamentos-table th:nth-child(9) { width: 19%; }  /* Observações */
#pedidos-table th:nth-child(10), #orcamentos-table th:nth-child(10) { width: 8%; }  /* Anexos */
#pedidos-table th:nth-child(11), #orcamentos-table th:nth-child(11) { width: 20%; }  /* Ações */

#pedidos-table td, #orcamentos-table td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Garantir visibilidade dos botões de ação */
#pedidos-table td:nth-child(11), #orcamentos-table td:nth-child(11) {
    overflow: visible !important;
    white-space: nowrap !important;
    min-width: 120px !important;
    text-align: center !important;
}

/* Estilo para botões de ação */
.btn-xs, .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.2;
    border-radius: 0.2rem;
    margin: 0 2px;
    display: inline-block !important;
    visibility: visible !important;
}

/* Estilo específico para o botão de relatório */
.btn-warning {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
    font-weight: 500 !important;
}

/* Garantir que os botões não sejam cortados */
.table-responsive {
    overflow-x: auto;
    overflow-y: visible;
}

/* CSS duplicado removido - mantido apenas acima */

/* Forçar visibilidade de todos os botões de ação */
td:last-child .btn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
}

/* Estilo específico para a coluna de ações */
td:last-child {
    white-space: nowrap !important;
    overflow: visible !important;
    min-width: 120px !important;
    padding: 0.5rem !important;
}

/* Remover destaque de debug da coluna de ações */

#pedidos-table td:nth-child(3), #orcamentos-table td:nth-child(3),
#pedidos-table td:nth-child(4), #orcamentos-table td:nth-child(4),
#pedidos-table td:nth-child(5), #orcamentos-table td:nth-child(5) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Estilos para o select de atualizações em tempo real */
#update-frequency {
    background-color: var(--card-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

#update-frequency:focus {
    background-color: var(--card-bg);
    color: var(--text-color);
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

[data-theme="dark"] #update-frequency {
    background-color: var(--card-bg);
    color: var(--text-color);
    border-color: var(--border-color);
}

[data-theme="dark"] #update-frequency:focus {
    background-color: var(--card-bg);
    color: var(--text-color);
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Responsividade para ajuste ao menu lateral */
.main-content {
    transition: all 0.3s ease;
}

.card {
    overflow: hidden;
}

.card-body {
    padding: 1rem;
    overflow-x: auto;
}

/* Ajuste das tabelas para diferentes tamanhos de tela */
@media (max-width: 1200px) {
    #pedidos-table th:nth-child(8), #orcamentos-table th:nth-child(8),
    #pedidos-table th:nth-child(9), #orcamentos-table th:nth-child(9) {
        width: 12%;
    }
    #pedidos-table th:nth-child(5), #orcamentos-table th:nth-child(5) {
        width: 18%;
    }
    /* Garantir que a coluna de ações seja sempre visível */
    #pedidos-table th:nth-child(11), #orcamentos-table th:nth-child(11) {
        width: 18% !important;
        min-width: 140px !important;
    }
}

@media (max-width: 992px) {
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Estilos para Drag and Drop de Anexos */
.anexos-cell-container {
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 40px;
    width: 100%;
}

.drag-drop-zone {
    border: 2px dashed #ccc;
    border-radius: 6px;
    padding: 6px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: transparent;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #666;
    flex: 1;
    min-width: 40px;
    max-width: 60px;
}

.drag-drop-zone:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
    color: #007bff;
}

.drag-drop-zone.drag-over {
    border-color: #007bff;
    background-color: #e3f2fd;
    color: #007bff;
}

.drag-drop-zone i {
    margin: 0;
}

.anexos-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.anexos-actions .btn {
    font-size: 11px;
    padding: 2px 6px;
}

/* Responsividade para dispositivos móveis */
@media (max-width: 768px) {
    .anexos-cell-container {
        min-height: 35px;
        gap: 6px;
    }
    
    .drag-drop-zone {
        min-height: 28px;
        font-size: 11px;
        padding: 4px 6px;
        min-width: 35px;
        max-width: 50px;
    }
    
    .anexos-actions .btn {
        font-size: 9px;
        padding: 1px 3px;
    }
    
    .anexos-cell-container .btn {
        min-height: 28px;
        font-size: 11px;
        padding: 4px 6px;
        min-width: 35px;
        max-width: 50px;
    }
}
</style>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-0">Painel de Controle</h1>
            <div class="mt-2">
                <span id="connection-status" class="badge bg-secondary">Conectando...</span>
                <small id="last-update-time" class="text-muted ms-2">Carregando...</small>
                <div class="mt-1">
                     <button id="toggle-auto-update" class="btn btn-sm btn-outline-primary" onclick="toggleAutoUpdate()">
                         <i class="fas fa-pause"></i> Pausar Atualização
                     </button>
                     <button class="btn btn-sm btn-outline-secondary" onclick="manualRefresh()" title="Atualizar Agora">
                         <i class="fas fa-sync-alt"></i>
                     </button>
                     <select id="update-frequency" class="form-control form-control-sm d-inline-block" style="width: auto; margin-left: 5px;" onchange="changeUpdateFrequency()">
                         <option value="3000">3s</option>
                         <option value="5000">5s</option>
                         <option value="10000">10s</option>
                         <option value="30000" selected>30s</option>
                         <option value="60000">1min</option>
                     </select>
                 </div>
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#importarEntradasModal">
                <i class="fas fa-file-upload"></i> Importar .xlsx
            </button>
            <a href="{{ url_for('exportar_painel') }}" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar .xlsx</a>
            <a href="{{ url_for('pedidos_arquivados') }}" class="btn btn-outline-secondary"><i class="fas fa-archive"></i> Ver Arquivados</a>
            <a href="{{ url_for('nova_entrada') }}" class="btn btn-primary shadow-sm"><i class="fas fa-plus fa-sm"></i> Nova Entrada</a>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Pedidos</div>
                            <div id="dash-pedidos-total" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.total }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-box fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Pedidos Não Iniciados</div>
                            <div id="dash-pedidos-nao-iniciado" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.nao_iniciado }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hourglass-start fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pedidos em Andamento</div>
                            <div id="dash-pedidos-em-andamento" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.em_andamento }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-tasks fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Pedidos Concluídos</div>
                            <div id="dash-pedidos-concluido" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.concluido }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total de Orçamentos</div>
                            <div id="dash-orcamentos-total" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.total }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-file-invoice fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Orçamentos Não Iniciados</div>
                            <div id="dash-orcamentos-nao-iniciado" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.nao_iniciado }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hourglass-start fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Orçamentos em Andamento</div>
                            <div id="dash-orcamentos-em-andamento" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.em_andamento }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-tasks fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Orçamentos Concluídos</div>
                            <div id="dash-orcamentos-concluido" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.concluido }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body py-2">
            <form method="GET" action="{{ url_for('painel_controle') }}">
                <div class="form-row align-items-end">
                    <div class="col-md-6">
                        <div class="form-group mb-0">
                            <label for="q" class="small">Buscar (N°, Cliente, Descrição)</label>
                            <input type="text" class="form-control form-control-sm" id="q" name="q" value="{{ search_query }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-0">
                            <label for="status" class="small">Filtrar por Status</label>
                            <select id="status" name="status" class="form-control form-control-sm">
                                <option value="">Todos</option>
                                <option value="Não iniciado" {% if selected_status == 'Não iniciado' %}selected{% endif %}>Não iniciado</option>
                                <option value="Em andamento" {% if selected_status == 'Em andamento' %}selected{% endif %}>Em andamento</option>
                                <option value="Concluído" {% if selected_status == 'Concluído' %}selected{% endif %}>Concluído</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-primary btn-sm btn-block" title="Filtrar">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group mb-0">
                            <a href="{{ url_for('painel_controle') }}" class="btn btn-secondary btn-sm btn-block" title="Limpar">
                                <i class="fas fa-eraser"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <h3>Pedidos</h3>
    
    <!-- Botões de ação em lote para Pedidos -->
    <div class="mb-3" id="pedidos-bulk-actions" style="display: none;">
        <div class="d-flex align-items-center">
            <span class="mr-3 text-muted"><span id="pedidos-selected-count">0</span> item(ns) selecionado(s)</span>
            <button type="button" class="btn btn-secondary btn-sm mr-2" onclick="bulkArchivePedidos()">
                <i class="fas fa-archive"></i> Arquivar Selecionados
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="bulkDeletePedidos()">
                <i class="fas fa-trash-alt"></i> Excluir Selecionados
            </button>
        </div>
    </div>
    
    <table id="pedidos-table" class="table table-hover table-sm shadow-sm rounded table-uppercase">
        <thead class="thead-light">
            <tr>
                <th width="30">
                    <input type="checkbox" id="select-all-pedidos" onchange="toggleAllPedidos(this)">
                </th>
                <th>Data</th>
                <th>N° Pedido</th>
                <th>N° Cliente</th>
                <th>Cliente</th>
                <th>Obra</th>
                <th>Status</th>
                <th>Descrição</th>
                <th>Observações</th>
                <th>Anexos</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for entrada in pedidos %}
            <tr>
                <td>
                    <input type="checkbox" class="pedido-checkbox" value="{{ entrada.id }}" onchange="updatePedidosBulkActions()">
                </td>
                <td>{{ entrada.data_registro.strftime('%d/%m/%Y') }}</td>
                <td>
                    <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#detalhesModal-{{ entrada.id }}">
                        {% if entrada.numero_pedido > 1000000 %}<i class="fas fa-search"></i> Detalhes{% else %}{{ entrada.numero_pedido }}{% endif %}
                    </button>
                </td>
                <td>
                    {% if entrada.cliente %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-{{ entrada.cliente.id }}">
                            {{ entrada.cliente.numero_cliente }}
                        </button>
                    {% else %}
                        <a href="{{ url_for('novo_cliente', tipo='rapido', nome=entrada.cliente_nome_temp) }}" class="btn btn-success btn-sm" title="Cadastrar este cliente">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </td>
                <td>{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</td>
                <td>{{ entrada.obra or '-' }}</td>
                <td>
                    {% set status_color = 'secondary' %}
                    {% if entrada.status == 'Concluído' %}
                        {% set status_color = 'success' %}
                    {% elif entrada.status == 'Em andamento' %}
                        {% set status_color = 'warning' %}
                    {% elif entrada.status == 'Não iniciado' %}
                        {% set status_color = 'danger' %}
                    {% endif %}
                    <div class="dropdown">
                        <button class="btn btn-{{ status_color }} btn-sm dropdown-toggle" type="button" id="status-btn-{{ entrada.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {{ entrada.status }}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="status-btn-{{ entrada.id }}">
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Não iniciado">Não iniciado</a>
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Em andamento">Em andamento</a>
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Concluído">Concluído</a>
                        </div>
                    </div>
                </td>
                <td>{{ (entrada.descricao or '') | truncate(20) }}</td>
                <td>{{ (entrada.observacoes or '') | truncate(20) or '-' }}</td>
                <td>
                    {% if entrada.anexos %}
                        <div class="anexos-compact-box" 
                             data-entrada-id="{{ entrada.id }}"
                             ondrop="dropAnexo(event, {{ entrada.id }})"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnter(event)"
                             ondragleave="dragLeave(event)"
                             data-toggle="modal" 
                             data-target="#galeriaAnexos-{{ entrada.id }}"
                             title="Clique para ver anexos ou arraste arquivos aqui">
                            <i class="fas fa-paperclip"></i>
                            <span class="anexos-count">{{ entrada.anexos|length }}</span>
                        </div>
                    {% else %}
                        <div class="anexos-compact-box anexos-empty" 
                             data-entrada-id="{{ entrada.id }}"
                             ondrop="dropAnexo(event, {{ entrada.id }})"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnter(event)"
                             ondragleave="dragLeave(event)"
                             title="Arraste arquivos aqui para adicionar anexos">
                            <i class="fas fa-plus"></i>
                            <span class="anexos-count">0</span>
                        </div>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('configurar_relatorio', id=entrada.id) }}" class="btn btn-sm btn-warning" title="Relatório">
                        <i class="fas fa-print"></i> Relatório
                    </a>
                    <form action="{{ url_for('arquivar_entrada', id=entrada.id) }}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-secondary" title="Arquivar">
                            <i class="fas fa-archive"></i>
                        </button>
                    </form>
                    <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-sm btn-info" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <form action="{{ url_for('excluir_entrada', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem a certeza?');">
                        <button type="submit" class="btn btn-sm btn-danger" title="Excluir">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center">Nenhum pedido ativo encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <br>
    <h3>Orçamentos</h3>
    
    <!-- Botões de ação em lote para Orçamentos -->
    <div class="mb-3" id="orcamentos-bulk-actions" style="display: none;">
        <div class="d-flex align-items-center">
            <span class="mr-3 text-muted"><span id="orcamentos-selected-count">0</span> item(ns) selecionado(s)</span>
            <button type="button" class="btn btn-secondary btn-sm mr-2" onclick="bulkArchiveOrcamentos()">
                <i class="fas fa-archive"></i> Arquivar Selecionados
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="bulkDeleteOrcamentos()">
                <i class="fas fa-trash-alt"></i> Excluir Selecionados
            </button>
        </div>
    </div>
    
    <table id="orcamentos-table" class="table table-hover table-sm shadow-sm rounded table-uppercase">
        <thead class="thead-light">
            <tr>
                <th width="30">
                    <input type="checkbox" id="select-all-orcamentos" onchange="toggleAllOrcamentos(this)">
                </th>
                <th>Data</th>
                <th>N° Pedido</th>
                <th>N° Cliente</th>
                <th>Cliente</th>
                <th>Obra</th>
                <th>Status</th>
                <th>Descrição</th>
                <th>Observações</th>
                <th>Anexos</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for entrada in orcamentos %}
            <tr>
                <td>
                    <input type="checkbox" class="orcamento-checkbox" value="{{ entrada.id }}" onchange="updateOrcamentosBulkActions()">
                </td>
                <td>{{ entrada.data_registro.strftime('%d/%m/%Y') }}</td>
                <td><button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#detalhesModal-{{ entrada.id }}">{% if entrada.numero_pedido > 1000000 %}<i class="fas fa-search"></i> Detalhes{% else %}{{ entrada.numero_pedido }}{% endif %}</button></td>
                <td>
                    {% if entrada.cliente %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-{{ entrada.cliente.id }}">
                            {{ entrada.cliente.numero_cliente }}
                        </button>
                    {% else %}
                        <a href="{{ url_for('novo_cliente', tipo='rapido', nome=entrada.cliente_nome_temp) }}" class="btn btn-success btn-sm" title="Cadastrar este cliente">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </td>
                <td>{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</td>
                <td>{{ entrada.obra or '-' }}</td>
                <td>
                    {% set status_color = 'secondary' %}
                    {% if entrada.status == 'Concluído' %}
                        {% set status_color = 'success' %}
                    {% elif entrada.status == 'Em andamento' %}
                        {% set status_color = 'warning' %}
                    {% elif entrada.status == 'Não iniciado' %}
                        {% set status_color = 'danger' %}
                    {% endif %}
                    <div class="dropdown">
                        <button class="btn btn-{{ status_color }} btn-sm dropdown-toggle" type="button" id="status-btn-{{ entrada.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {{ entrada.status }}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="status-btn-{{ entrada.id }}">
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Não iniciado">Não iniciado</a>
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Em andamento">Em andamento</a>
                            <a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Concluído">Concluído</a>
                        </div>
                    </div>
                </td>
                <td>{{ (entrada.descricao or '') | truncate(20) }}</td>
                <td>{{ (entrada.observacoes or '') | truncate(20) or '-' }}</td>
                <td>
                    {% if entrada.anexos %}
                        <div class="anexos-compact-box" 
                             data-entrada-id="{{ entrada.id }}"
                             ondrop="dropAnexo(event, {{ entrada.id }})"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnter(event)"
                             ondragleave="dragLeave(event)"
                             data-toggle="modal" 
                             data-target="#galeriaAnexos-{{ entrada.id }}"
                             title="Clique para ver anexos ou arraste arquivos aqui">
                            <i class="fas fa-paperclip"></i>
                            <span class="anexos-count">{{ entrada.anexos|length }}</span>
                        </div>
                    {% else %}
                        <div class="anexos-compact-box anexos-empty" 
                             data-entrada-id="{{ entrada.id }}"
                             ondrop="dropAnexo(event, {{ entrada.id }})"
                             ondragover="allowDrop(event)"
                             ondragenter="dragEnter(event)"
                             ondragleave="dragLeave(event)"
                             title="Arraste arquivos aqui para adicionar anexos">
                            <i class="fas fa-plus"></i>
                            <span class="anexos-count">0</span>
                        </div>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('converter_para_pedido', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Converter em Pedido?');">
                        <button type="submit" class="btn btn-xs btn-success" title="Converter">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </form>
                    <form action="{{ url_for('arquivar_entrada', id=entrada.id) }}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-xs btn-secondary" title="Arquivar">
                            <i class="fas fa-archive"></i>
                        </button>
                    </form>
                    <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-xs btn-info" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <form action="{{ url_for('excluir_entrada', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem a certeza?');">
                        <button type="submit" class="btn btn-xs btn-danger" title="Excluir">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center">Nenhum orçamento encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block modals %}
    {# --- MODAL DE IMPORTAÇÃO (FORA DE QUALQUER LOOP) --- #}
    <div class="modal fade" id="importarEntradasModal" tabindex="-1" role="dialog" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importarModalLabel">Importar Entradas de .xlsx</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{{ url_for('importar_entradas') }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <p>O seu ficheiro .xlsx deve ter as colunas na seguinte ordem, sem cabeçalho na primeira linha. As colunas com (*) são obrigatórias.</p>
                        <ul class="list-group mb-3">
                            <li class="list-group-item"><strong>Coluna A:</strong> N° Pedido (*)</li>
                            <li class="list-group-item"><strong>Coluna B:</strong> Tipo (Pedido ou Orçamento) (*)</li>
                            <li class="list-group-item"><strong>Coluna C:</strong> Nome do Cliente (*)</li>
                            <li class="list-group-item"><strong>Coluna D:</strong> Obra</li>
                            <li class="list-group-item"><strong>Coluna E:</strong> Status (Não iniciado, Em andamento, Concluído)</li>
                            <li class="list-group-item"><strong>Coluna F:</strong> Descrição (*)</li>
                            <li class="list-group-item"><strong>Coluna G:</strong> Observações</li>
                        </ul>
                        <div class="form-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="xlsx_file" name="xlsx_file" accept=".xlsx" required>
                                <label class="custom-file-label" for="xlsx_file">Escolher ficheiro...</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# --- LOOP PRINCIPAL PARA GERAR MODAIS PARA CADA ENTRADA --- #}
    {% for entrada in pedidos + orcamentos %}
    
        {% if entrada.cliente %}
        <div class="modal fade" id="clienteDetalhesModal-{{ entrada.cliente.id }}" tabindex="-1" role="dialog" aria-labelledby="clienteModalLabel-{{ entrada.cliente.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clienteModalLabel-{{ entrada.cliente.id }}">Detalhes de: {{ entrada.cliente.nome }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Dados Pessoais</h6><hr class="mt-1 mb-2">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">N° Cliente:</dt><dd class="col-sm-8">{{ entrada.cliente.numero_cliente }}</dd>
                                    <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.nome }}</dd>
                                    <dt class="col-sm-4">Telefone:</dt><dd class="col-sm-8">{{ entrada.cliente.telefone or '-' }}</dd>
                                    <dt class="col-sm-4">Tipo Pessoa:</dt><dd class="col-sm-8">{{ entrada.cliente.tipo_pessoa }}</dd>
                                    <dt class="col-sm-4">CPF/CNPJ:</dt><dd class="col-sm-8">{{ entrada.cliente.cpf_cnpj or '-' }}</dd>
                                    <dt class="col-sm-4">Como Conheceu:</dt><dd class="col-sm-8">{{ entrada.cliente.como_conheceu or '-' }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6>Endereço</h6><hr class="mt-1 mb-2">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Rua:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.rua or '-' }}</dd>
                                    <dt class="col-sm-4">Número:</dt><dd class="col-sm-8">{{ entrada.cliente.numero_endereco or '-' }}</dd>
                                    <dt class="col-sm-4">Complemento:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.complemento or '-' }}</dd>
                                    <dt class="col-sm-4">Bairro:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.bairro or '-' }}</dd>
                                    <dt class="col-sm-4">Cidade:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.cidade or '-' }}</dd>
                                    <dt class="col-sm-4">UF:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.uf or '-' }}</dd>
                                    <dt class="col-sm-4">CEP:</dt><dd class="col-sm-8">{{ entrada.cliente.cep or '-' }}</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Observações</h6><hr class="mt-1 mb-2">
                                <p style="white-space: pre-wrap;">{{ entrada.cliente.observacoes or 'Nenhuma observação.' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <a href="{{ url_for('editar_cliente', id=entrada.cliente.id) }}" class="btn btn-primary">Editar Cliente</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="modal fade" id="detalhesModal-{{ entrada.id }}" tabindex="-1" role="dialog" aria-labelledby="detalhesModalLabel-{{ entrada.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detalhesModalLabel-{{ entrada.id }}">Detalhes do {{ entrada.tipo }} #{{ entrada.numero_pedido }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-primary"></i> Informações Gerais</h6><hr class="mt-1">
                                <dl class="row">
                                    <dt class="col-sm-5">N° da Entrada</dt><dd class="col-sm-7">{{ entrada.numero_pedido }}</dd>
                                    <dt class="col-sm-5">Tipo</dt><dd class="col-sm-7">{{ entrada.tipo }}</dd>
                                    <dt class="col-sm-5">Data de Registo</dt><dd class="col-sm-7">{{ entrada.data_registro.strftime('%d/%m/%Y às %H:%M') }}</dd>
                                    <dt class="col-sm-5">Cliente</dt><dd class="col-sm-7 text-uppercase">{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</dd>
                                    <dt class="col-sm-5">Status</dt><dd class="col-sm-7">{% set status_color = 'secondary' %}{% if entrada.status == 'Concluído' %}{% set status_color = 'success' %}{% elif entrada.status == 'Em andamento' %}{% set status_color = 'warning' %}{% elif entrada.status == 'Não iniciado' %}{% set status_color = 'danger' %}{% endif %}<span class="badge badge-{{ status_color }}">{{ entrada.status }}</span></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-hard-hat text-primary"></i> Obra</h6><hr class="mt-1">
                                <p class="text-uppercase">{{ entrada.obra or 'Não especificada' }}</p>

                                <h6 class="mt-4"><i class="fas fa-paperclip text-primary"></i> Anexos</h6><hr class="mt-1">
                                <p class="text-muted small">Total de {{ entrada.anexos|length }} anexo(s).</p>
                                <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-plus"></i> Gerir Anexos</a>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="fas fa-align-left text-primary"></i> Descrição</h6><hr class="mt-1">
                                <p class="text-uppercase" style="white-space: pre-wrap;">{{ (entrada.descricao or '') }}</p>
                                <h6 class="mt-3"><i class="fas fa-comment-alt text-primary"></i> Observações</h6><hr class="mt-1">
                                <p class="text-uppercase" style="white-space: pre-wrap;">{{ entrada.observacoes or 'Nenhuma observação.' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-info"><i class="fas fa-edit"></i> Editar</a>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        {% if entrada.anexos %}
            <div class="modal fade" id="galeriaAnexos-{{ entrada.id }}" tabindex="-1" aria-labelledby="modalLabel-{{ entrada.id }}" aria-hidden="true">
                <div class="modal-dialog" style="max-width: none; width: 100vw; height: 100vh; margin: 0;">
                    <div class="modal-content" style="height: 100%; border: 0; border-radius: 0;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel-{{ entrada.id }}" style="text-transform: uppercase;">Anexos : Pedido #{{ entrada.numero_pedido }} - {% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}{% if entrada.obra %} ( {{ entrada.obra }} ){% endif %}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body p-0" style="flex-grow: 1;">
                            <div id="carouselAnexos-{{ entrada.id }}" class="carousel slide h-100" data-ride="carousel" data-interval="false">
                                <ol class="carousel-indicators">
                                    {% for _ in entrada.anexos %}
                                        <li data-target="#carouselAnexos-{{ entrada.id }}" data-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}"></li>
                                    {% endfor %}
                                </ol>
                                <div class="carousel-inner h-100">
                                    {% for anexo in entrada.anexos %}
                                    <div class="carousel-item text-center h-100 {% if loop.first %}active{% endif %}">
                                        {% if anexo.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')) %}
                                            <div class="d-flex justify-content-center align-items-center h-100 position-relative" style="background-color: #343a40;">
                                                <img src="{{ url_for('uploaded_file', filename=anexo.filename) }}" class="panzoom-image" style="object-fit: contain; max-width: 100%; max-height: 100%; cursor: grab;" alt="{{ anexo.filename }}">
                                                
                                                <!-- Controles de imagem -->
                                                <div class="image-controls position-absolute" style="top: 10px; right: 10px; z-index: 1050;">
                                                    <div class="btn-group-vertical" role="group">
                                                        <button type="button" class="btn btn-dark btn-sm rotate-left" title="Rodar à esquerda">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-dark btn-sm rotate-right" title="Rodar à direita">
                                                            <i class="fas fa-redo"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-dark btn-sm zoom-in" title="Ampliar">
                                                             <i class="fas fa-search-plus"></i>
                                                         </button>
                                                         <button type="button" class="btn btn-dark btn-sm zoom-out" title="Diminuir">
                                                             <i class="fas fa-search-minus"></i>
                                                         </button>
                                                         <button type="button" class="btn btn-dark btn-sm zoom-reset" title="Reset zoom">
                                                             <i class="fas fa-expand-arrows-alt"></i>
                                                         </button>
                                                        <button type="button" class="btn btn-dark btn-sm download-image" title="Download" data-filename="{{ anexo.filename }}">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-dark btn-sm print-image" title="Imprimir" data-filename="{{ anexo.filename }}">
                                                            <i class="fas fa-print"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif anexo.filename.lower().endswith('.pdf') %}
                                            <iframe src="{{ url_for('uploaded_file', filename=anexo.filename) }}" width="100%" height="100%" style="border: none;"></iframe>
                                        {% else %}
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <div class="text-center">
                                                    <i class="fas fa-file-alt fa-10x text-muted"></i>
                                                    <p class="mt-3">Não é possível pré-visualizar.</p>
                                                    <a href="{{ url_for('uploaded_file', filename=anexo.filename) }}" class="btn btn-primary" target="_blank">Descarregar</a>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if entrada.anexos|length > 1 %}
                                <a class="carousel-control-prev" href="#carouselAnexos-{{ entrada.id }}" role="button" data-slide="prev" style="width: 40px; height: 40px; top: 50%; transform: translateY(-50%); left: 10px;">
                    <span class="carousel-control-prev-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px;"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselAnexos-{{ entrada.id }}" role="button" data-slide="next" style="width: 40px; height: 40px; top: 50%; transform: translateY(-50%); right: 10px;">
                    <span class="carousel-control-next-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px;"></span>
                    <span class="sr-only">Next</span>
                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Modal de Configuração do Relatório -->
        <div class="modal fade" id="relatorioModal-{{ entrada.id }}" tabindex="-1" role="dialog" aria-labelledby="relatorioModalLabel-{{ entrada.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="relatorioModalLabel-{{ entrada.id }}">Configurar Relatório - Pedido {{ entrada.numero_pedido }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="relatorioForm-{{ entrada.id }}">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="relatorio-data-{{ entrada.id }}">Data da Entrada:</label>
                                        <input type="date" class="form-control" id="relatorio-data-{{ entrada.id }}" value="{{ entrada.data_registro.strftime('%Y-%m-%d') }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="relatorio-numero-pedido-{{ entrada.id }}">N° do Pedido:</label>
                                        <input type="text" class="form-control" id="relatorio-numero-pedido-{{ entrada.id }}" value="{{ entrada.numero_pedido }}">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="relatorio-numero-cliente-{{ entrada.id }}">N° do Cliente:</label>
                                        <input type="text" class="form-control" id="relatorio-numero-cliente-{{ entrada.id }}" value="{% if entrada.cliente %}{{ entrada.cliente.numero_cliente }}{% else %}S/N{% endif %}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="relatorio-nome-cliente-{{ entrada.id }}">Nome do Cliente:</label>
                                        <input type="text" class="form-control" id="relatorio-nome-cliente-{{ entrada.id }}" value="{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="relatorio-obra-{{ entrada.id }}">Obra:</label>
                                <input type="text" class="form-control" id="relatorio-obra-{{ entrada.id }}" value="{{ entrada.obra or '' }}">
                            </div>
                            
                            {% if entrada.anexos %}
                            <div class="form-group">
                                <label>Selecionar Anexos para o Relatório:</label>
                                <div class="row" id="anexos-selection-{{ entrada.id }}">
                                    {% for anexo in entrada.anexos %}
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center p-2">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="anexo-{{ anexo.id }}" name="anexos_selecionados" value="{{ anexo.id }}" checked>
                                                    <label class="form-check-label" for="anexo-{{ anexo.id }}">
                                                        Incluir
                                                    </label>
                                                </div>
                                                {% if anexo.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp')) %}
                                                     <img src="{{ url_for('uploaded_file', filename=anexo.filename) }}" class="img-thumbnail" style="max-width: 80px; max-height: 80px;" alt="{{ anexo.filename }}">
                                                 {% elif anexo.filename.lower().endswith('.pdf') %}
                                                     <i class="fas fa-file-pdf fa-3x text-danger"></i>
                                                 {% else %}
                                                     <i class="fas fa-file fa-3x text-secondary"></i>
                                                 {% endif %}
                                                 <div class="mt-1">
                                                     <small class="text-muted">{{ anexo.filename[:15] }}{% if anexo.filename|length > 15 %}...{% endif %}</small>
                                                 </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="gerarRelatorio({{ entrada.id }})">Visualizar Relatório</button>
                    </div>
                </div>
            </div>
        </div>

    {% endfor %}

{% endblock %}

{% block scripts %}
    <!-- Sistema modular do painel -->
    <script src="{{ url_for('static', filename='js/painel-sistema.js') }}"></script>
    
    <script>
    // Compatibilidade com sistema legado - será removido em versões futuras
    window.PAINEL_SYSTEM = window.PAINEL_SYSTEM || {
        isInitialized: false,
        isInitializing: false,
        initPromise: null,
        observers: [],
        statusInterval: null,
        initTimeout: null,
        autoUpdateInterval: null,
        lastUpdateTime: null
    };
    
    // Função para destruir completamente o sistema anterior
     window.PAINEL_SYSTEM.destroy = function() {
         console.log('Destruindo sistema anterior...');
         
         // Cancela timeout de inicialização se existir
         if (this.initTimeout) {
             clearTimeout(this.initTimeout);
             this.initTimeout = null;
         }
         
         // Para todos os intervals
         if (this.statusInterval) {
             clearInterval(this.statusInterval);
             this.statusInterval = null;
         }
         
         if (this.autoUpdateInterval) {
             clearInterval(this.autoUpdateInterval);
             this.autoUpdateInterval = null;
         }
         

         
         // Remove todos os observers
         this.observers.forEach(observer => {
             if (observer && observer.disconnect) {
                 observer.disconnect();
             }
         });
         this.observers = [];
         
         // Remove todos os event listeners personalizados
         document.querySelectorAll('[data-listener-attached]').forEach(element => {
             element.removeAttribute('data-listener-attached');
         });
         
         // Reset flags
         this.isInitialized = false;
         this.isInitializing = false;
         this.initPromise = null;
     };
    
    // Função de inicialização única com debounce
     window.PAINEL_SYSTEM.safeInitialize = function() {
         // Se já está inicializado, ignora
         if (this.isInitialized) {
             console.log('Sistema já inicializado, ignorando');
             return Promise.resolve();
         }
         
         // Se já está inicializando, retorna a promise existente
         if (this.isInitializing && this.initPromise) {
             console.log('Inicialização já em andamento, aguardando...');
             return this.initPromise;
         }
         
         // Marca como inicializando
         this.isInitializing = true;
         
         // Cria nova promise de inicialização
         this.initPromise = new Promise((resolve, reject) => {
             // Cancela timeout anterior se existir
             if (this.initTimeout) {
                 clearTimeout(this.initTimeout);
             }
             
             // Debounce de 50ms para evitar múltiplas inicializações
             this.initTimeout = setTimeout(() => {
                 try {
                     console.log('Executando inicialização única...');
                     
                     // Limpa recursos anteriores
                     this.destroy();
                     
                     // Marca como inicializado ANTES de executar
                     this.isInitialized = true;
                     this.isInitializing = false;
                     
                     // Executa inicializações
                     initializeStatusSystem();
                     protectModals();
                     initializeAutoUpdate();
                     
                     console.log('Sistema inicializado com sucesso');
                     resolve();
                 } catch (error) {
                     console.error('Erro na inicialização:', error);
                     this.isInitialized = false;
                     this.isInitializing = false;
                     reject(error);
                 }
             }, 50);
         });
         
         return this.initPromise;
     };
    
    document.addEventListener('DOMContentLoaded', function() {
          // Usa inicialização segura com debounce
          window.PAINEL_SYSTEM.safeInitialize().catch(error => {
              console.error('Falha na inicialização do sistema:', error);
          });
      });
    
    // Proteção adicional contra recarregamentos
      window.addEventListener('beforeunload', function() {
          window.PAINEL_SYSTEM.destroy();
      });
      
      // Proteção contra mudanças de visibilidade da página
      document.addEventListener('visibilitychange', function() {
          if (document.visibilityState === 'visible' && window.PAINEL_SYSTEM.isInitialized) {
              // Reaplica estilos quando a página volta a ficar visível
              setTimeout(() => {
                  protectModals();
                  restoreAnexosContent();
              }, 100);
              
              // Reativa atualização automática se estava pausada
              if (!window.PAINEL_SYSTEM.autoUpdateInterval) {
                  initializeAutoUpdate();
              }
          } else if (document.visibilityState === 'hidden') {
              // Pausa atualização automática quando página não está visível
              if (window.PAINEL_SYSTEM.autoUpdateInterval) {
                  clearInterval(window.PAINEL_SYSTEM.autoUpdateInterval);
                  window.PAINEL_SYSTEM.autoUpdateInterval = null;
                  console.log('Atualização automática pausada (página oculta)');
              }
          }
      });
    
    // Função para restaurar conteúdo de anexos se alterado
    function restoreAnexosContent() {
        document.querySelectorAll('.anexos-cell[data-original-content]').forEach(cell => {
            if (cell.innerHTML !== cell.getAttribute('data-original-content')) {
                console.log('Restaurando conteúdo de anexos alterado');
                cell.innerHTML = cell.getAttribute('data-original-content');
            }
        });
    }
    
    // Sistema de atualização de status via dropdown
    function initializeStatusSystem() {
        const statusOptions = document.querySelectorAll('.status-option');
        const colorMap = {
            'Não iniciado': 'btn-danger',
            'Em andamento': 'btn-warning',
            'Concluído': 'btn-success'
        };

        statusOptions.forEach(option => {
            // Remove listeners anteriores para evitar duplicação
            option.removeEventListener('click', handleStatusClick);
            option.addEventListener('click', handleStatusClick);
        });
        
        function handleStatusClick(event) {
            event.preventDefault();
            const entryId = this.dataset.id;
            const newStatus = this.dataset.status;

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/atualizar-status/' + entryId, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        // Atualiza o botão de status na tabela
                        const button = document.getElementById('status-btn-' + entryId);
                        if (button) {
                            button.textContent = newStatus;
                            button.classList.remove('btn-danger', 'btn-warning', 'btn-success', 'btn-secondary');
                            button.classList.add(colorMap[newStatus] || 'btn-secondary');
                        }

                        // Atualiza dashboards
                        updateDashboards(data.dashboard);

                    } else {
                        alert('Erro ao atualizar o status: ' + data.message);
                    }
                } else {
                    alert('Ocorreu um erro na resposta do servidor.');
                }
            };

            xhr.onerror = function() {
                alert('Ocorreu um erro de comunicação com o servidor.');
            };

            xhr.send(JSON.stringify({ status: newStatus }));
        }
    }
    
    // Função auxiliar para atualizar dashboards
    function updateDashboards(dashboard) {
        if (dashboard && dashboard.pedidos) {
            document.getElementById('dash-pedidos-total').textContent = dashboard.pedidos.total;
            document.getElementById('dash-pedidos-nao-iniciado').textContent = dashboard.pedidos.nao_iniciado;
            document.getElementById('dash-pedidos-em-andamento').textContent = dashboard.pedidos.em_andamento;
            document.getElementById('dash-pedidos-concluido').textContent = dashboard.pedidos.concluido;
        }
        
        if (dashboard && dashboard.orcamentos) {
            document.getElementById('dash-orcamentos-total').textContent = dashboard.orcamentos.total;
            document.getElementById('dash-orcamentos-nao-iniciado').textContent = dashboard.orcamentos.nao_iniciado;
            document.getElementById('dash-orcamentos-em-andamento').textContent = dashboard.orcamentos.em_andamento;
            document.getElementById('dash-orcamentos-concluido').textContent = dashboard.orcamentos.concluido;
        }
    }
    
    // Função para atualizar tabelas - Versão revisada e otimizada
    function updateTables(tablesData) {
        try {
            console.log('DEBUG: updateTables chamada com dados:', tablesData);
            // Validação de entrada
            if (!tablesData || typeof tablesData !== 'object') {
                console.warn('Dados de tabelas inválidos recebidos:', tablesData);
                return;
            }
            
            // Atualiza pedidos se disponível
            if (tablesData.pedidos_data && Array.isArray(tablesData.pedidos_data)) {
                console.log(`Atualizando ${tablesData.pedidos_data.length} pedidos`);
                updatePedidosTable(tablesData.pedidos_data);
            } else if (tablesData.pedidos_data !== undefined) {
                console.warn('Dados de pedidos em formato inválido:', tablesData.pedidos_data);
            }
            
            // Atualiza orçamentos se disponível
            if (tablesData.orcamentos_data && Array.isArray(tablesData.orcamentos_data)) {
                console.log(`Atualizando ${tablesData.orcamentos_data.length} orçamentos`);
                updateOrcamentosTable(tablesData.orcamentos_data);
            } else if (tablesData.orcamentos_data !== undefined) {
                console.warn('Dados de orçamentos em formato inválido:', tablesData.orcamentos_data);
            }
            
            // Log de sucesso
            console.log('Atualização de tabelas concluída com sucesso');
            
        } catch (error) {
            console.error('Erro crítico durante atualização das tabelas:', error);
            // Notifica o usuário sobre o erro
            if (window.PainelSistema && window.PainelSistema.notifications) {
                window.PainelSistema.notifications.show('Erro ao atualizar tabelas. Tente recarregar a página.', 'error');
            }
        }
    }
    
    // Função para atualizar tabela de pedidos - Versão revisada e otimizada
    function updatePedidosTable(pedidosData) {
        try {
            console.log('DEBUG: updatePedidosTable executada com', pedidosData?.length || 0, 'pedidos:', pedidosData);
            // Validação de entrada
            if (!Array.isArray(pedidosData)) {
                console.error('Dados de pedidos inválidos:', pedidosData);
                return;
            }
            
            const tableBody = document.querySelector('#pedidos-table tbody');
            if (!tableBody) {
                console.error('Elemento tbody da tabela de pedidos não encontrado!');
                return;
            }
            
            // Limpa o conteúdo atual de forma segura
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
        
            // Função auxiliar para sanitizar dados
            const sanitize = (value) => {
                if (value === null || value === undefined) return '';
                return String(value).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
            };
            
            // Adiciona as novas linhas de forma otimizada
            const fragment = document.createDocumentFragment();
            
            pedidosData.forEach((pedido, index) => {
                try {
                    // Validação básica do pedido
                    if (!pedido || !pedido.id) {
                        console.warn(`Pedido inválido no índice ${index}:`, pedido);
                        return;
                    }
                    
                    const row = document.createElement('tr');
                    
                    // Monta o HTML da linha de forma mais segura
                    const cellsHTML = [
                        // Checkbox
                        `<input type="checkbox" class="pedido-checkbox" value="${sanitize(pedido.id)}" onchange="updatePedidosBulkActions()">`,
                        
                        // Data
                        sanitize(pedido.data_cadastro || ''),
                        
                        // Número do pedido - será tratado especialmente no forEach
                        '',
                        
                        // Cliente
                        pedido.numero_cliente ? 
                            `<button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-${sanitize(pedido.cliente_id)}">
                                ${sanitize(pedido.numero_cliente)}
                            </button>` : 
                            `<a href="/novo_cliente/rapido?nome=${encodeURIComponent(pedido.nome_cliente || '')}" class="btn btn-success btn-sm" title="Cadastrar este cliente">
                                <i class="fas fa-plus"></i>
                            </a>`,
                        
                        // Nome do cliente
                        sanitize(pedido.nome_cliente || ''),
                        
                        // Trabalho
                        sanitize(pedido.obra || ''),
                        
                        // Status dropdown
                        `<div class="dropdown">
                            <button class="btn ${getStatusButtonColor(pedido.status)} btn-sm dropdown-toggle" type="button" id="status-btn-${sanitize(pedido.id)}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                ${sanitize(pedido.status || 'Não iniciado')}
                            </button>
                            <div class="dropdown-menu" aria-labelledby="status-btn-${sanitize(pedido.id)}">
                                <a class="dropdown-item status-option" href="#" data-id="${sanitize(pedido.id)}" data-status="Não iniciado">Não iniciado</a>
                                <a class="dropdown-item status-option" href="#" data-id="${sanitize(pedido.id)}" data-status="Em andamento">Em andamento</a>
                                <a class="dropdown-item status-option" href="#" data-id="${sanitize(pedido.id)}" data-status="Concluído">Concluído</a>
                            </div>
                        </div>`,
                        
                        // Descrição
                        sanitize(pedido.descricao || ''),
                        
                        // Observações
                        sanitize(pedido.observacoes || ''),
                        
                        // Anexos com drag and drop
                        (pedido.anexos_count > 0) ? 
                            `<div class="anexos-cell-container" data-entry-id="${sanitize(pedido.id)}" data-entry-type="pedido" style="display: flex; align-items: center; gap: 8px;">
                                <div class="drag-drop-zone" style="flex: 1; min-width: 40px; max-width: 60px; padding: 6px; border: 2px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; color: #666; cursor: pointer;" title="Arraste arquivos aqui ou clique para selecionar">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#galeriaAnexos-${sanitize(pedido.id)}" style="flex-shrink: 0; min-width: 40px; max-width: 60px; padding: 6px; border-radius: 4px; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-paperclip"></i> ${sanitize(pedido.anexos_count)}
                                </button>
                            </div>` : 
                            `<div class="anexos-cell-container" data-entry-id="${sanitize(pedido.id)}" data-entry-type="pedido">
                                <div class="drag-drop-zone" style="padding: 8px; border: 2px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; color: #666; cursor: pointer; max-width: 60px;" title="Arraste arquivos aqui ou clique para selecionar">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>`,
                        
                        // Ações
                        `<div class="d-flex gap-1">
                            <a href="/configurar-relatorio/${sanitize(pedido.id)}" class="btn btn-sm btn-warning" title="Relatório">
                                <i class="fas fa-print"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="archivePedido(${sanitize(pedido.id)})" title="Arquivar">
                                <i class="fas fa-archive"></i>
                            </button>
                            <a href="/editar/${sanitize(pedido.id)}" class="btn btn-sm btn-info" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePedido(${sanitize(pedido.id)})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`
                    ];
                    
                    // Cria as células
                    cellsHTML.forEach((cellHTML, index) => {
                        const cell = document.createElement('td');
                        
                        // Tratamento especial para o botão de detalhes (índice 2)
                    if (index === 2) {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn btn-outline-secondary btn-sm';
                        button.style.color = 'var(--text-color)';
                        button.setAttribute('data-toggle', 'modal');
                        button.setAttribute('data-target', `#detalhesModal-${pedido.id}`);
                        
                        // Lógica corrigida para pedidos
                         if (pedido.numero_pedido && pedido.numero_pedido > 1000000) {
                             const icon = document.createElement('i');
                             icon.className = 'fas fa-search';
                             icon.style.marginRight = '5px';
                             button.appendChild(icon);
                             button.appendChild(document.createTextNode('Detalhes'));
                         } else {
                             button.textContent = pedido.numero_pedido || 'Detalhes';
                         }
                        
                        cell.appendChild(button);
                        createDetalhesModal(pedido);
                    } else {
                        cell.innerHTML = cellHTML;
                    }
                        
                        row.appendChild(cell);
                    });
                    
                    fragment.appendChild(row);
                    
                } catch (error) {
                    console.error(`Erro ao processar pedido ${pedido.id}:`, error);
                }
            });
            
            // Adiciona todas as linhas de uma vez
            tableBody.appendChild(fragment);
        
            // Atualiza ações em lote
            if (typeof updatePedidosBulkActions === 'function') {
                updatePedidosBulkActions();
            }
            
            // Reinicializa sistema de status para novos elementos
            if (typeof initializeStatusSystem === 'function') {
                initializeStatusSystem();
            }
            
            // Inicializa drag and drop para anexos
            initializeDragDropAnexos();
            
            console.log(`Tabela de pedidos atualizada com ${pedidosData.length} registros`);
            
        } catch (error) {
            console.error('Erro crítico ao atualizar tabela de pedidos:', error);
            
            // Notifica o usuário sobre o erro
            if (window.PainelSistema && window.PainelSistema.notifications) {
                window.PainelSistema.notifications.show('Erro ao atualizar tabela de pedidos. Recarregue a página.', 'error');
            }
            
            // Tenta restaurar estado anterior se possível
            const tableBody = document.querySelector('#pedidos-table tbody');
            if (tableBody && tableBody.children.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">Erro ao carregar dados. Recarregue a página.</td></tr>';
            }
        }
    }
    
    // Função para atualizar tabela de orçamentos - Versão revisada e otimizada
    function updateOrcamentosTable(orcamentosData) {
        try {
            // Validação de entrada
            if (!Array.isArray(orcamentosData)) {
                console.error('Dados de orçamentos inválidos:', orcamentosData);
                return;
            }
            
            const tableBody = document.querySelector('#orcamentos-table tbody');
            if (!tableBody) {
                console.error('Elemento tbody da tabela de orçamentos não encontrado!');
                return;
            }
            
            // Limpa o conteúdo atual de forma segura
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // Função auxiliar para sanitizar dados
            const sanitize = (value) => {
                if (value === null || value === undefined) return '';
                return String(value).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
            };
            
            // Adiciona as novas linhas de forma otimizada
            const fragment = document.createDocumentFragment();
        
        // Processa cada orçamento de forma segura
        orcamentosData.forEach((orcamento, index) => {
            try {
                // Validação básica dos dados do orçamento
                if (!orcamento || !orcamento.id) {
                    console.warn(`Orçamento inválido no índice ${index}:`, orcamento);
                    return;
                }
                
                const row = document.createElement('tr');
                
                // Criação segura do HTML da linha
                const cellsHTML = [
                    `<input type="checkbox" class="orcamento-checkbox" value="${sanitize(orcamento.id)}" onchange="updateOrcamentosBulkActions()">`,
                    sanitize(orcamento.data_cadastro || ''),
                    // Número do pedido - será tratado especialmente no forEach
                     '',
                    orcamento.numero_cliente ? 
                        `<button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-${sanitize(orcamento.cliente_id)}">${sanitize(orcamento.numero_cliente)}</button>` :
                        `<a href="/novo_cliente/rapido?nome=${encodeURIComponent(orcamento.nome_cliente || '')}" class="btn btn-success btn-sm" title="Cadastrar este cliente"><i class="fas fa-plus"></i></a>`,
                    sanitize(orcamento.nome_cliente || ''),
                    sanitize(orcamento.obra || ''),
                    `<div class="dropdown">
                        <button class="btn ${getStatusButtonColor(orcamento.status)} btn-sm dropdown-toggle" type="button" id="status-btn-${sanitize(orcamento.id)}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            ${sanitize(orcamento.status || 'Não iniciado')}
                        </button>
                        <div class="dropdown-menu" aria-labelledby="status-btn-${sanitize(orcamento.id)}">
                            <a class="dropdown-item status-option" href="#" data-id="${sanitize(orcamento.id)}" data-status="Não iniciado">Não iniciado</a>
                            <a class="dropdown-item status-option" href="#" data-id="${sanitize(orcamento.id)}" data-status="Em andamento">Em andamento</a>
                            <a class="dropdown-item status-option" href="#" data-id="${sanitize(orcamento.id)}" data-status="Concluído">Concluído</a>
                        </div>
                    </div>`,
                    sanitize(orcamento.descricao || ''),
                    sanitize(orcamento.observacoes || ''),
                    (orcamento.anexos_count > 0) ? 
                         `<div class="anexos-cell-container" data-entry-id="${sanitize(orcamento.id)}" data-entry-type="orcamento" style="display: flex; align-items: center; gap: 8px;">
                             <div class="drag-drop-zone" style="flex: 1; min-width: 40px; max-width: 60px; padding: 6px; border: 2px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; color: #666; cursor: pointer;" title="Arraste arquivos aqui ou clique para selecionar">
                                 <i class="fas fa-plus"></i>
                             </div>
                             <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#galeriaAnexos-${sanitize(orcamento.id)}" style="flex-shrink: 0; min-width: 40px; max-width: 60px; padding: 6px; border-radius: 4px; font-size: 12px; min-height: 32px; display: flex; align-items: center; justify-content: center;">
                                 <i class="fas fa-paperclip"></i> ${sanitize(orcamento.anexos_count)}
                             </button>
                         </div>` :
                         `<div class="anexos-cell-container" data-entry-id="${sanitize(orcamento.id)}" data-entry-type="orcamento">
                             <div class="drag-drop-zone" style="padding: 8px; border: 2px dashed #ccc; border-radius: 4px; text-align: center; font-size: 12px; color: #666; cursor: pointer; max-width: 60px;" title="Arraste arquivos aqui ou clique para selecionar">
                                 <i class="fas fa-plus"></i>
                             </div>
                         </div>`,
                    `<div class="d-flex gap-1">
                        <button type="button" class="btn btn-sm btn-success" onclick="convertToPedido(${sanitize(orcamento.id)})" title="Converter em Pedido"><i class="fas fa-exchange-alt"></i></button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="archiveOrcamento(${sanitize(orcamento.id)})" title="Arquivar"><i class="fas fa-archive"></i></button>
                        <a href="/editar/${sanitize(orcamento.id)}" class="btn btn-sm btn-info" title="Editar"><i class="fas fa-edit"></i></a>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteOrcamento(${sanitize(orcamento.id)})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>`
                ];
                
                // Adiciona as células à linha
                cellsHTML.forEach((cellHTML, index) => {
                    const cell = document.createElement('td');
                    
                    // Tratamento especial para o botão de detalhes (índice 2)
                     if (index === 2) {
                         const button = document.createElement('button');
                         button.type = 'button';
                         button.className = 'btn btn-outline-secondary btn-sm';
                         button.style.color = 'var(--text-color)';
                         button.setAttribute('data-toggle', 'modal');
                         button.setAttribute('data-target', `#detalhesModal-${orcamento.id}`);
                         
                         // Lógica corrigida para orçamentos
                          if (orcamento.numero_pedido && orcamento.numero_pedido <= 1000000) {
                              button.textContent = orcamento.numero_pedido;
                          } else {
                              const icon = document.createElement('i');
                              icon.className = 'fas fa-search';
                              icon.style.marginRight = '5px';
                              button.appendChild(icon);
                              button.appendChild(document.createTextNode('Detalhes'));
                          }
                         
                         cell.appendChild(button);
                         createDetalhesModal(orcamento);
                     } else {
                         cell.innerHTML = cellHTML;
                     }
                    
                    row.appendChild(cell);
                });
                
                fragment.appendChild(row);
                
            } catch (error) {
                console.error(`Erro ao processar orçamento ${orcamento?.id || index}:`, error);
            }
        });
        
        // Adiciona todas as linhas de uma vez
        tableBody.appendChild(fragment);
        
        // Atualiza ações em lote e reinicializa sistema de status
        try {
            if (typeof updateOrcamentosBulkActions === 'function') {
                updateOrcamentosBulkActions();
            }
            if (typeof initializeStatusSystem === 'function') {
                initializeStatusSystem();
            }
            
            // Inicializa drag and drop para anexos
            initializeDragDropAnexos();
            
        } catch (error) {
            console.error('Erro ao inicializar sistemas auxiliares:', error);
        }
        
        console.log(`Tabela de orçamentos atualizada com ${orcamentosData.length} registros`);
        
        } catch (error) {
            console.error('Erro crítico na atualização da tabela de orçamentos:', error);
            
            // Notifica o usuário sobre o erro
            if (typeof showNotification === 'function') {
                showNotification('Erro ao carregar orçamentos. Tente recarregar a página.', 'error');
            }
            
            // Fallback: exibe mensagem de erro na tabela
            const tableBody = document.querySelector('#orcamentos-table tbody');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Erro ao carregar dados dos orçamentos</td></tr>';
            }
        }
    }
    
    // Função auxiliar para obter cor do status
    function getStatusColor(status) {
        const statusColors = {
            'Não Iniciado': 'bg-secondary',
            'Em Andamento': 'bg-warning text-dark',
            'Concluído': 'bg-success',
            'Arquivado': 'bg-dark',
            'Cancelado': 'bg-danger'
        };
        return statusColors[status] || 'bg-secondary';
    }
    
    // Função para criar modal de detalhes dinamicamente
    function createDetalhesModal(entrada) {
        // Verifica se o modal já existe
        if (document.getElementById(`detalhesModal-${entrada.id}`)) {
            return;
        }
        
        // Formata a data
        const dataRegistro = entrada.data_registro ? new Date(entrada.data_registro).toLocaleString('pt-BR') : 'N/A';
        
        // Determina a cor do status
        let statusColor = 'secondary';
        if (entrada.status === 'Concluído') statusColor = 'success';
        else if (entrada.status === 'Em andamento') statusColor = 'warning';
        else if (entrada.status === 'Não iniciado') statusColor = 'danger';
        
        // Cria o HTML do modal
        const modalHTML = `
            <div class="modal fade" id="detalhesModal-${entrada.id}" tabindex="-1" role="dialog" aria-labelledby="detalhesModalLabel-${entrada.id}" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="detalhesModalLabel-${entrada.id}">Detalhes do ${entrada.tipo || 'Registro'} #${entrada.numero_pedido}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle text-primary"></i> Informações Gerais</h6><hr class="mt-1">
                                    <dl class="row">
                                        <dt class="col-sm-5">N° da Entrada</dt><dd class="col-sm-7">${entrada.numero_pedido}</dd>
                                        <dt class="col-sm-5">Tipo</dt><dd class="col-sm-7">${entrada.tipo || 'N/A'}</dd>
                                        <dt class="col-sm-5">Data de Registo</dt><dd class="col-sm-7">${dataRegistro}</dd>
                                        <dt class="col-sm-5">Cliente</dt><dd class="col-sm-7 text-uppercase">${entrada.nome_cliente || entrada.cliente_nome_temp || 'N/A'}</dd>
                                        <dt class="col-sm-5">Status</dt><dd class="col-sm-7"><span class="badge badge-${statusColor}">${entrada.status || 'N/A'}</span></dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-hard-hat text-primary"></i> Obra</h6><hr class="mt-1">
                                    <p class="text-uppercase">${entrada.obra || 'Não especificada'}</p>

                                    <h6 class="mt-4"><i class="fas fa-paperclip text-primary"></i> Anexos</h6><hr class="mt-1">
                                    <p class="text-muted small">Total de ${entrada.anexos_count || 0} anexo(s).</p>
                                    <a href="/editar/${entrada.id}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-plus"></i> Gerir Anexos</a>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-align-left text-primary"></i> Descrição</h6><hr class="mt-1">
                                    <p class="text-uppercase" style="white-space: pre-wrap;">${entrada.descricao || ''}</p>
                                    <h6 class="mt-3"><i class="fas fa-comment-alt text-primary"></i> Observações</h6><hr class="mt-1">
                                    <p class="text-uppercase" style="white-space: pre-wrap;">${entrada.observacoes || 'Nenhuma observação.'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="/editar/${entrada.id}" class="btn btn-info"><i class="fas fa-edit"></i> Editar</a>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adiciona o modal ao DOM
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Sistema de Drag and Drop para Anexos
    function initializeDragDropAnexos() {
        try {
            console.log('Inicializando sistema de drag and drop para anexos...');
            
            // Seleciona todas as zonas de drag and drop
            const dropZones = document.querySelectorAll('.drag-drop-zone');
            
            dropZones.forEach(zone => {
                // Remove listeners anteriores para evitar duplicação
                zone.removeEventListener('dragover', handleDragOver);
                zone.removeEventListener('dragenter', handleDragEnter);
                zone.removeEventListener('dragleave', handleDragLeave);
                zone.removeEventListener('drop', handleDrop);
                zone.removeEventListener('click', handleZoneClick);
                
                // Adiciona novos listeners
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('click', handleZoneClick);
            });
            
            console.log(`Drag and drop inicializado para ${dropZones.length} zonas`);
            
        } catch (error) {
            console.error('Erro ao inicializar drag and drop:', error);
        }
    }
    
    // Handlers para eventos de drag and drop
    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#007bff';
        this.style.backgroundColor = '#f8f9fa';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#007bff';
        this.style.backgroundColor = '#f8f9fa';
    }
    
    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        this.style.borderColor = '#ccc';
        this.style.backgroundColor = 'transparent';
    }
    
    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Restaura estilo visual
        this.style.borderColor = '#ccc';
        this.style.backgroundColor = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const container = this.closest('.anexos-cell-container');
            const entryId = container.getAttribute('data-entry-id');
            const entryType = container.getAttribute('data-entry-type');
            
            uploadAnexosFiles(files, entryId, entryType, this);
        }
    }
    
    function handleZoneClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const container = this.closest('.anexos-cell-container');
        const entryId = container.getAttribute('data-entry-id');
        const entryType = container.getAttribute('data-entry-type');
        
        // Cria input file temporário
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.accept = '.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt';
        
        fileInput.onchange = (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                uploadAnexosFiles(files, entryId, entryType, this);
            }
        };
        
        fileInput.click();
    }
    
    // Função para upload de arquivos de anexos
    async function uploadAnexosFiles(files, entryId, entryType, dropZone) {
        try {
            console.log(`Iniciando upload de ${files.length} arquivo(s) para ${entryType} ${entryId}`);
            
            // Mostra indicador de carregamento
            const originalContent = dropZone.innerHTML;
            dropZone.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            dropZone.style.pointerEvents = 'none';
            
            // Prepara FormData
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('anexos', files[i]);
            }
            formData.append('entrada_id', entryId);
            
            // Envia arquivos
            const response = await fetch('/upload_anexos', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('Upload realizado com sucesso:', result);
                
                // Mostra notificação de sucesso
                if (typeof showUpdateNotification === 'function') {
                    showUpdateNotification(`${files.length} arquivo(s) adicionado(s) com sucesso!`, 'success');
                }
                
                // Força atualização da tabela para refletir os novos anexos
                if (window.PAINEL_SYSTEM && typeof window.PAINEL_SYSTEM.fetchUpdatedData === 'function') {
                    window.PAINEL_SYSTEM.isManualRefresh = true;
                    await window.PAINEL_SYSTEM.fetchUpdatedData();
                }
                
            } else {
                throw new Error(result.message || 'Erro no upload');
            }
            
        } catch (error) {
            console.error('Erro no upload de anexos:', error);
            
            // Mostra notificação de erro
            if (typeof showUpdateNotification === 'function') {
                showUpdateNotification('Erro ao enviar arquivos. Tente novamente.', 'error');
            }
            
        } finally {
            // Restaura conteúdo original
            dropZone.innerHTML = originalContent;
            dropZone.style.pointerEvents = 'auto';
        }
    }
    
    // Função auxiliar para obter cor do botão de status
    function getStatusButtonColor(status) {
        const statusColors = {
            'Não iniciado': 'btn-danger',
            'Em andamento': 'btn-warning',
            'Concluído': 'btn-success',
            'Arquivado': 'btn-dark',
            'Cancelado': 'btn-danger'
        };
        return statusColors[status] || 'btn-secondary';
    }
    
    // Função para atualizar status de conexão
    function updateConnectionStatus(isConnected, serverTime = null) {
        const statusIndicator = document.getElementById('connection-status');
        const lastUpdateElement = document.getElementById('last-update-time');
        
        if (statusIndicator) {
            if (isConnected) {
                statusIndicator.className = 'badge bg-success';
                statusIndicator.textContent = 'Conectado';
            } else {
                statusIndicator.className = 'badge bg-danger';
                statusIndicator.textContent = 'Desconectado';
            }
        }
        
        if (lastUpdateElement) {
            const now = new Date();
            lastUpdateElement.textContent = 'Última atualização: ' + now.toLocaleTimeString();
            if (serverTime) {
                lastUpdateElement.title = 'Hora do servidor: ' + serverTime;
            }
        }
    }
    
    // Função para mostrar notificações de atualização
    function showUpdateNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed';
        notification.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999; min-width: 200px; max-width: 250px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 6px; animation: slideInRight 0.3s ease-out; font-size: 12px; padding: 8px 12px;';
        notification.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" style="font-size: 10px; padding: 2px;"></button>';
        
        document.body.appendChild(notification);
        
        // Auto-remover após 2 segundos com animação (tempo reduzido)
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 2000);
    }
    
    // Sistema de atualização automática - Versão revisada e otimizada
    function initializeAutoUpdate() {
        try {
            console.log('Iniciando sistema de atualização automática...');
            
            // Validação do sistema global
            if (!window.PAINEL_SYSTEM) {
                console.error('PAINEL_SYSTEM não está disponível!');
                return false;
            }
            
            // Inicializa variáveis do sistema de forma segura
            Object.assign(window.PAINEL_SYSTEM, {
                autoUpdateActive: true,
                updateInterval: 30000,
                failedAttempts: 0,
                maxFailedAttempts: 5,
                connectionStatus: 'connecting',
                lastData: null,
                isManualRefresh: false,
                lastUpdateTime: null,
                retryDelay: 5000
            });
            
            // Limpa intervalo anterior se existir
            if (window.PAINEL_SYSTEM.autoUpdateInterval) {
                clearInterval(window.PAINEL_SYSTEM.autoUpdateInterval);
                window.PAINEL_SYSTEM.autoUpdateInterval = null;
            }
        
        // Função para buscar dados atualizados - Versão otimizada
        async function fetchUpdatedData() {
            // Verifica se o sistema ainda está ativo
            if (!window.PAINEL_SYSTEM?.autoUpdateActive) {
                console.log('Sistema de atualização pausado');
                return;
            }
            
            // Verifica se há filtros ativos - se sim, não atualiza as tabelas automaticamente
            const searchQuery = document.getElementById('q')?.value?.trim() || '';
            const selectedStatus = document.getElementById('status')?.value || '';
            const hasActiveFilters = searchQuery !== '' || selectedStatus !== '';
            
            if (hasActiveFilters) {
                console.log('Filtros ativos detectados - pulando atualização automática das tabelas');
                // Ainda atualiza o dashboard, mas não as tabelas
                window.PAINEL_SYSTEM.skipTableUpdate = true;
            } else {
                window.PAINEL_SYSTEM.skipTableUpdate = false;
            }
            
            console.log('Iniciando requisição para /api/dashboard_data');
            
            // Atualiza status para 'carregando' de forma segura
            const statusIndicator = document.getElementById('connection-status');
            if (statusIndicator) {
                statusIndicator.className = 'badge bg-warning';
                statusIndicator.textContent = 'Carregando...';
            }
            
            try {
                // Configuração da requisição com timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                
                const response = await fetch('/api/dashboard_data', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('Resposta recebida:', response.status, response.statusText);
                
                // Tratamento de redirecionamento (sessão expirada)
                if (response.status === 302 || response.redirected) {
                    console.error('Redirecionamento detectado - problema de autenticação');
                    updateConnectionStatus(false);
                    if (typeof showUpdateNotification === 'function') {
                        showUpdateNotification('Sessão expirada. Faça login novamente.', 'warning');
                    }
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Validação dos dados recebidos
                if (!data || typeof data !== 'object') {
                    throw new Error('Dados inválidos recebidos da API');
                }
                
                console.log('Dados recebidos da API:', data.success ? 'Sucesso' : 'Erro');
                
                if (data.success) {
                    // Detecta mudanças nos dados
                    const hasChanges = detectDataChanges(data);
                    
                    // Atualiza dashboards de forma segura
                    if (data.dashboard && typeof updateDashboards === 'function') {
                        updateDashboards(data.dashboard);
                    }
                    
                    // Atualiza tabelas se disponíveis e não há filtros ativos
                    if (data.tables && typeof updateTables === 'function' && !window.PAINEL_SYSTEM.skipTableUpdate) {
                        console.log('Atualizando tabelas...');
                        updateTables(data.tables);
                    } else if (window.PAINEL_SYSTEM.skipTableUpdate) {
                        console.log('Atualização de tabelas pulada devido a filtros ativos');
                    } else {
                        console.warn('Nenhum dado de tabela recebido ou função updateTables não disponível!');
                    }
                    
                    // Atualiza indicadores de status
                    if (typeof updateConnectionStatus === 'function') {
                        updateConnectionStatus(true, data.server_time);
                    }
                    
                    // Mostra notificação apenas se for atualização manual
                    if (window.PAINEL_SYSTEM.isManualRefresh && typeof showUpdateNotification === 'function') {
                        if (hasChanges) {
                            showUpdateNotification('Dados atualizados com sucesso!', 'success');
                        } else {
                            showUpdateNotification('Dados já estão atualizados', 'info');
                        }
                        window.PAINEL_SYSTEM.isManualRefresh = false;
                    }
                    
                    // Armazena dados para comparação futura
                    window.PAINEL_SYSTEM.lastData = JSON.stringify(data);
                    window.PAINEL_SYSTEM.lastUpdateTime = new Date();
                    window.PAINEL_SYSTEM.connectionStatus = 'connected';
                    window.PAINEL_SYSTEM.failedAttempts = 0;
                    
                } else {
                    throw new Error(data.message || 'Resposta inválida da API');
                }
                
            } catch (error) {
                console.error('Erro na atualização automática:', error);
                
                // Tratamento específico para diferentes tipos de erro
                if (error.name === 'AbortError') {
                    console.warn('Requisição cancelada por timeout');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    console.error('Erro de rede ou conectividade');
                }
                
                handleUpdateError(error);
            }
        }
        
        // Função para detectar mudanças nos dados
        function detectDataChanges(newData) {
            if (!window.PAINEL_SYSTEM.lastData) {
                return false; // Primeira execução
            }
            
            const lastDataStr = window.PAINEL_SYSTEM.lastData;
            const newDataStr = JSON.stringify(newData);
            
            return lastDataStr !== newDataStr;
        }
        
        // Função para lidar com erros de atualização - Versão otimizada
        function handleUpdateError(error = null) {
            window.PAINEL_SYSTEM.failedAttempts = (window.PAINEL_SYSTEM.failedAttempts || 0) + 1;
            window.PAINEL_SYSTEM.connectionStatus = 'disconnected';
            window.PAINEL_SYSTEM.lastErrorTime = new Date();
            
            // Atualiza status de conexão de forma segura
            if (typeof updateConnectionStatus === 'function') {
                updateConnectionStatus(false);
            }
            
            // Determina o tipo de erro para melhor tratamento
            let errorType = 'unknown';
            let userMessage = 'Problemas de conexão detectados';
            
            if (error) {
                if (error.name === 'AbortError') {
                    errorType = 'timeout';
                    userMessage = 'Timeout na conexão com o servidor';
                } else if (error.name === 'TypeError') {
                    errorType = 'network';
                    userMessage = 'Erro de rede ou conectividade';
                } else if (error.message?.includes('HTTP')) {
                    errorType = 'http';
                    userMessage = 'Erro do servidor';
                }
            }
            
            // Mostra notificação de erro após várias tentativas falhadas
            if (window.PAINEL_SYSTEM.failedAttempts >= 3 && typeof showUpdateNotification === 'function') {
                showUpdateNotification(userMessage, 'warning');
            }
            
            // Implementa backoff exponencial para reconexão
            const maxAttempts = window.PAINEL_SYSTEM.maxFailedAttempts || 5;
            if (window.PAINEL_SYSTEM.failedAttempts >= maxAttempts) {
                const backoffDelay = Math.min(60000, window.PAINEL_SYSTEM.retryDelay * Math.pow(2, window.PAINEL_SYSTEM.failedAttempts - maxAttempts));
                console.warn(`Muitas tentativas falharam. Aumentando intervalo para ${backoffDelay}ms`);
                
                if (typeof adjustUpdateInterval === 'function') {
                    adjustUpdateInterval(backoffDelay);
                }
            }
            
            console.error(`Erro de atualização (tentativa ${window.PAINEL_SYSTEM.failedAttempts}/${maxAttempts}):`, {
                type: errorType,
                message: error?.message || 'Erro desconhecido',
                timestamp: new Date().toISOString()
            });
        }
        
        // Torna fetchUpdatedData disponível globalmente
        window.PAINEL_SYSTEM.fetchUpdatedData = fetchUpdatedData;
        
        // Executa primeira atualização imediatamente
        try {
            fetchUpdatedData();
        } catch (error) {
            console.error('Erro na primeira atualização:', error);
        }
        
        // Configura atualização automática com intervalo configurado
        window.PAINEL_SYSTEM.autoUpdateInterval = setInterval(fetchUpdatedData, window.PAINEL_SYSTEM.updateInterval);
        
        console.log(`Sistema de atualização automática ativo (${window.PAINEL_SYSTEM.updateInterval/1000}s)`);
        return true;
        
        } catch (error) {
            console.error('Erro crítico ao inicializar sistema de atualização automática:', error);
            
            // Notifica o usuário sobre o erro crítico
            if (typeof showUpdateNotification === 'function') {
                showUpdateNotification('Erro ao inicializar sistema de atualização. Recarregue a página.', 'error');
            }
            
            return false;
        }
    }
    
    // Função para ajustar intervalo de atualização (escopo global)
    function adjustUpdateInterval(newInterval) {
        if (window.PAINEL_SYSTEM.autoUpdateInterval) {
            clearInterval(window.PAINEL_SYSTEM.autoUpdateInterval);
        }
        
        window.PAINEL_SYSTEM.autoUpdateInterval = setInterval(window.PAINEL_SYSTEM.fetchUpdatedData, newInterval);
        window.PAINEL_SYSTEM.updateInterval = newInterval;
        console.log('Intervalo de atualização ajustado para ' + newInterval + 'ms');
    }
    
    // Função para pausar/retomar atualização automática (escopo global)
    function toggleAutoUpdate() {
        const button = document.getElementById('toggle-auto-update');
        
        if (window.PAINEL_SYSTEM.autoUpdateActive) {
            // Pausar
            if (window.PAINEL_SYSTEM.autoUpdateInterval) {
                clearInterval(window.PAINEL_SYSTEM.autoUpdateInterval);
            }
            window.PAINEL_SYSTEM.autoUpdateActive = false;
            button.innerHTML = '<i class="fas fa-play"></i> Retomar Atualização';
            button.className = 'btn btn-sm btn-outline-success';
        } else {
            // Retomar
            const frequency = parseInt(document.getElementById('update-frequency').value);
            window.PAINEL_SYSTEM.autoUpdateInterval = setInterval(window.PAINEL_SYSTEM.fetchUpdatedData, frequency);
            window.PAINEL_SYSTEM.autoUpdateActive = true;
            button.innerHTML = '<i class="fas fa-pause"></i> Pausar Atualização';
            button.className = 'btn btn-sm btn-outline-primary';
        }
    }
    
    // Função para alterar frequência de atualização (escopo global)
    function changeUpdateFrequency() {
        const frequency = parseInt(document.getElementById('update-frequency').value);
        
        if (window.PAINEL_SYSTEM.autoUpdateActive) {
            adjustUpdateInterval(frequency);
        } else {
            window.PAINEL_SYSTEM.updateInterval = frequency;
        }
    }
    
    // Função para atualização manual (escopo global)
    function manualRefresh() {
        showUpdateNotification('Atualizando dados manualmente...', 'info');
        window.PAINEL_SYSTEM.isManualRefresh = true;
        window.PAINEL_SYSTEM.fetchUpdatedData();
    }
    
    // Função para obter a classe CSS baseada no status
    function getStatusClass(status) {
        if (status === 'Não iniciado') {
            return 'status-nao-iniciado';
        } else if (status === 'Em andamento') {
            return 'status-em-andamento';
        } else if (status === 'Concluído') {
            return 'status-concluido';
        }
        return '';
    }

    
    // Função para proteger modais contra sobreposições
    function protectModals() {
        // Protege modais de descrição de cliente
        document.querySelectorAll('[data-toggle="modal"]').forEach(trigger => {
            if (!trigger.hasAttribute('data-modal-protected')) {
                trigger.setAttribute('data-modal-protected', 'true');
                
                // Garante que o modal funcione corretamente
                trigger.addEventListener('click', function(e) {
                    const targetModal = document.querySelector(this.getAttribute('data-target'));
                    if (targetModal) {
                        // Força a exibição do modal
                        setTimeout(() => {
                            if (window.jQuery && window.jQuery.fn.modal) {
                                $(targetModal).modal('show');
                            }
                        }, 10);
                    }
                });
            }
        });
        
        // Protege conteúdo de anexos
        document.querySelectorAll('.anexos-cell').forEach(cell => {
            if (!cell.hasAttribute('data-content-protected')) {
                cell.setAttribute('data-content-protected', 'true');
                // Preserva o conteúdo original
                cell.setAttribute('data-original-content', cell.innerHTML);
            }
        });
    }
    
    // Funções para seleção em massa - PEDIDOS
    function toggleAllPedidos(selectAllCheckbox) {
        const checkboxes = document.querySelectorAll('.pedido-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updatePedidosBulkActions();
    }
    
    function updatePedidosBulkActions() {
        const checkboxes = document.querySelectorAll('.pedido-checkbox');
        const checkedBoxes = document.querySelectorAll('.pedido-checkbox:checked');
        const bulkActions = document.getElementById('pedidos-bulk-actions');
        const selectedCount = document.getElementById('pedidos-selected-count');
        const selectAllCheckbox = document.getElementById('select-all-pedidos');
        
        selectedCount.textContent = checkedBoxes.length;
        
        if (checkedBoxes.length > 0) {
            bulkActions.style.display = 'block';
        } else {
            bulkActions.style.display = 'none';
        }
        
        // Atualiza o estado do checkbox "selecionar todos"
        if (checkedBoxes.length === checkboxes.length && checkboxes.length > 0) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }
    
    // Funções para seleção em massa - ORÇAMENTOS
    function toggleAllOrcamentos(selectAllCheckbox) {
        const checkboxes = document.querySelectorAll('.orcamento-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateOrcamentosBulkActions();
    }
    
    function updateOrcamentosBulkActions() {
        const checkboxes = document.querySelectorAll('.orcamento-checkbox');
        const checkedBoxes = document.querySelectorAll('.orcamento-checkbox:checked');
        const bulkActions = document.getElementById('orcamentos-bulk-actions');
        const selectedCount = document.getElementById('orcamentos-selected-count');
        const selectAllCheckbox = document.getElementById('select-all-orcamentos');
        
        selectedCount.textContent = checkedBoxes.length;
        
        if (checkedBoxes.length > 0) {
            bulkActions.style.display = 'block';
        } else {
            bulkActions.style.display = 'none';
        }
        
        // Atualiza o estado do checkbox "selecionar todos"
        if (checkedBoxes.length === checkboxes.length && checkboxes.length > 0) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }
    
    // Funções de ação em lote - PEDIDOS
    function bulkArchivePedidos() {
        const checkedBoxes = document.querySelectorAll('.pedido-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (ids.length === 0) {
            alert('Nenhum pedido selecionado.');
            return;
        }
        
        if (confirm('Tem certeza que deseja arquivar ' + ids.length + ' pedido(s) selecionado(s)?')) {
            bulkAction('archive', ids, 'pedidos');
        }
    }
    
    function bulkDeletePedidos() {
        const checkedBoxes = document.querySelectorAll('.pedido-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (ids.length === 0) {
            alert('Nenhum pedido selecionado.');
            return;
        }
        
        if (confirm('ATENÇÃO: Esta ação irá excluir permanentemente ' + ids.length + ' pedido(s) selecionado(s). Tem certeza?')) {
            bulkAction('delete', ids, 'pedidos');
        }
    }
    
    // Funções de ação em lote - ORÇAMENTOS
    function bulkArchiveOrcamentos() {
        const checkedBoxes = document.querySelectorAll('.orcamento-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (ids.length === 0) {
            alert('Nenhum orçamento selecionado.');
            return;
        }
        
        if (confirm('Tem certeza que deseja arquivar ' + ids.length + ' orçamento(s) selecionado(s)?')) {
            bulkAction('archive', ids, 'orcamentos');
        }
    }
    
    function bulkDeleteOrcamentos() {
        const checkedBoxes = document.querySelectorAll('.orcamento-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (ids.length === 0) {
            alert('Nenhum orçamento selecionado.');
            return;
        }
        
        if (confirm('ATENÇÃO: Esta ação irá excluir permanentemente ' + ids.length + ' orçamento(s) selecionado(s). Tem certeza?')) {
            bulkAction('delete', ids, 'orcamentos');
        }
    }
    
    // Função genérica para ações em lote
    function bulkAction(action, ids, type) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/bulk-action', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + (data.message || 'Ocorreu um erro desconhecido.'));
                }
            } else {
                alert('Erro de comunicação com o servidor.');
            }
        };
        
        xhr.onerror = function() {
            alert('Erro de comunicação com o servidor.');
        };
        
        xhr.send(JSON.stringify({
            action: action,
            ids: ids,
            type: type
        }));
    }
    
    // Funções individuais para pedidos
    function archivePedido(id) {
        if (confirm('Tem certeza que deseja arquivar este pedido?')) {
            bulkAction('archive', [id], 'pedidos');
        }
    }
    
    function deletePedido(id) {
        if (confirm('ATENÇÃO: Esta ação irá excluir permanentemente este pedido. Tem certeza?')) {
            bulkAction('delete', [id], 'pedidos');
        }
    }
    
    // Funções individuais para orçamentos
    function archiveOrcamento(id) {
        if (confirm('Tem certeza que deseja arquivar este orçamento?')) {
            bulkAction('archive', [id], 'orcamentos');
        }
    }
    
    function deleteOrcamento(id) {
        if (confirm('ATENÇÃO: Esta ação irá excluir permanentemente este orçamento. Tem certeza?')) {
            bulkAction('delete', [id], 'orcamentos');
        }
    }
    
    function convertToPedido(id) {
        if (confirm('Tem certeza que deseja converter este orçamento em pedido?')) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/converter/' + id, true);
            
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    alert('Orçamento convertido em pedido com sucesso!');
                    location.reload();
                } else {
                    alert('Erro de comunicação com o servidor.');
                }
            };
            
            xhr.onerror = function() {
                alert('Erro de comunicação com o servidor.');
            };
            
            xhr.send();
        }
    }
    
    // Funcionalidades para controles de imagem
    document.addEventListener('DOMContentLoaded', function() {
        // Zoom in
         document.addEventListener('click', function(e) {
             if (e.target.closest('.zoom-in')) {
                 const carouselItem = e.target.closest('.carousel-item');
                 const img = carouselItem.querySelector('.panzoom-image');
                 if (img && img.panzoom) {
                     img.panzoom.zoomIn();
                 }
             }
         });
         
         // Zoom out
         document.addEventListener('click', function(e) {
             if (e.target.closest('.zoom-out')) {
                 const carouselItem = e.target.closest('.carousel-item');
                 const img = carouselItem.querySelector('.panzoom-image');
                 if (img && img.panzoom) {
                     img.panzoom.zoomOut();
                 }
             }
         });
         
         // Reset de zoom
         document.addEventListener('click', function(e) {
             if (e.target.closest('.zoom-reset')) {
                 const carouselItem = e.target.closest('.carousel-item');
                 const img = carouselItem.querySelector('.panzoom-image');
                 if (img && img.panzoom) {
                     img.panzoom.reset();
                     img.dataset.rotation = '0';
                 }
             }
         });
        
        // Download de imagem
        document.addEventListener('click', function(e) {
            if (e.target.closest('.download-image')) {
                const button = e.target.closest('.download-image');
                const filename = button.getAttribute('data-filename');
                const link = document.createElement('a');
                link.href = '/uploads/' + filename;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
        
        // Impressão de imagem
        document.addEventListener('click', function(e) {
            if (e.target.closest('.print-image')) {
                const button = e.target.closest('.print-image');
                const filename = button.getAttribute('data-filename');
                const imageUrl = '/uploads/' + filename;
                
                // Criar uma nova janela para impressão
                const printWindow = window.open('', '_blank');
                
                // Criar documento HTML usando DOM
                printWindow.document.write('<!DOCTYPE html>');
                printWindow.document.write('<html><head>');
                printWindow.document.write('<title>Imprimir - ' + filename + '</title>');
                printWindow.document.write('<style>');
                printWindow.document.write('body { margin: 0; padding: 20px; text-align: center; }');
                printWindow.document.write('img { max-width: 100%; max-height: 90vh; object-fit: contain; }');
                printWindow.document.write('@media print { body { margin: 0; padding: 0; } img { max-width: 100%; max-height: 100vh; } }');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<img src="' + imageUrl + '" alt="' + filename + '">');
                printWindow.document.write('<script>window.onload = function() { window.print(); window.close(); };<\/script>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            }
        });
    });
    
    // Função global para gerar relatório
    window.gerarRelatorio = async function(entradaId) {
        // Coletar dados do formulário
        const data = document.getElementById('relatorio-data-' + entradaId).value;
        const numeroPedido = document.getElementById('relatorio-numero-pedido-' + entradaId).value;
        const numeroCliente = document.getElementById('relatorio-numero-cliente-' + entradaId).value;
        const nomeCliente = document.getElementById('relatorio-nome-cliente-' + entradaId).value;
        const obra = document.getElementById('relatorio-obra-' + entradaId).value;
        
        // Coletar anexos selecionados
        const anexosSelecionados = [];
        const anexosData = [];
        const checkboxes = document.querySelectorAll('#relatorioModal-' + entradaId + ' input[name="anexos_selecionados"]:checked');
        
        // Buscar dados dos anexos selecionados
        try {
            const response = await fetch('/api/entrada/' + entradaId + '/anexos');
            const result = await response.json();
            
            if (result.success) {
                checkboxes.forEach(checkbox => {
                    const anexoId = parseInt(checkbox.value);
                    const anexo = result.anexos.find(a => a.id === anexoId);
                    if (anexo) {
                        anexosSelecionados.push(anexoId);
                        anexosData.push(anexo);
                    }
                });
            }
        } catch (error) {
            console.error('Erro ao buscar anexos:', error);
        }
        
        // Fechar modal de configuração
        $('#relatorioModal-' + entradaId).modal('hide');
        
        // Criar modal de visualização do relatório
        criarModalRelatorio({
            entradaId,
            data,
            numeroPedido,
            numeroCliente,
            nomeCliente,
            obra,
            anexos: anexosData
        });
    };

    // Função para gerar relatório
    async function openRelatorioModal(entradaId, numeroPedido, dataRegistro, clienteNome, clienteNumero, obra) {
        // Remove modal existente se houver
        const existingModal = document.getElementById('relatorioModal-' + entradaId);
        if (existingModal) {
            existingModal.remove();
        }
        
        // Formatar data do formato dd/mm/yyyy para yyyy-mm-dd
        let dataFormatada = '';
        if (dataRegistro) {
            try {
                const parts = dataRegistro.split('/');
                if (parts.length === 3) {
                    dataFormatada = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                } else {
                    dataFormatada = dataRegistro;
                }
            } catch (e) {
                dataFormatada = dataRegistro;
            }
        }
        
        // Buscar anexos da entrada
        let anexos = [];
        try {
            const response = await fetch('/api/entrada/' + entradaId + '/anexos');
            if (response.ok) {
                const data = await response.json();
                anexos = data.anexos || [];
            }
        } catch (e) {
            console.error('Erro ao buscar anexos:', e);
        }
        
        // Criar HTML do modal
        let modalHTML = '<div class="modal fade" id="relatorioModal-' + entradaId + '" tabindex="-1" role="dialog" aria-labelledby="relatorioModalLabel-' + entradaId + '" aria-hidden="true">' +
            '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                    '<div class="modal-header">' +
                        '<h5 class="modal-title" id="relatorioModalLabel-' + entradaId + '">Configurar Relatório - Pedido ' + numeroPedido + '</h5>' +
                        '<button type="button" class="close" data-dismiss="modal" aria-label="Close">' +
                            '<span aria-hidden="true">&times;</span>' +
                        '</button>' +
                    '</div>' +
                    '<div class="modal-body">' +
                        '<form id="relatorioForm-' + entradaId + '">' +
                            '<div class="row">' +
                                '<div class="col-md-6">' +
                                    '<div class="form-group">' +
                                        '<label for="relatorio-data-' + entradaId + '">Data da Entrada:</label>' +
                                        '<input type="date" class="form-control" id="relatorio-data-' + entradaId + '" value="' + dataFormatada + '">' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-6">' +
                                    '<div class="form-group">' +
                                        '<label for="relatorio-numero-pedido-' + entradaId + '">N° do Pedido:</label>' +
                                        '<input type="text" class="form-control" id="relatorio-numero-pedido-' + entradaId + '" value="' + (numeroPedido || '') + '">' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="row">' +
                                '<div class="col-md-6">' +
                                    '<div class="form-group">' +
                                        '<label for="relatorio-numero-cliente-' + entradaId + '">N° do Cliente:</label>' +
                                        '<input type="text" class="form-control" id="relatorio-numero-cliente-' + entradaId + '" value="' + (clienteNumero || 'S/N') + '">' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-6">' +
                                    '<div class="form-group">' +
                                        '<label for="relatorio-nome-cliente-' + entradaId + '">Nome do Cliente:</label>' +
                                        '<input type="text" class="form-control" id="relatorio-nome-cliente-' + entradaId + '" value="' + (clienteNome || '') + '">' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label for="relatorio-obra-' + entradaId + '">Obra:</label>' +
                                '<input type="text" class="form-control" id="relatorio-obra-' + entradaId + '" value="' + (obra || '') + '">' +
                            '</div>';
        
        // Adicionar seção de anexos se existirem
        if (anexos && anexos.length > 0) {
            modalHTML += '<div class="form-group">' +
                '<label>Selecionar Anexos para o Relatório:</label>' +
                '<div class="row" id="anexos-selection-' + entradaId + '">';
            
            anexos.forEach(function(anexo) {
                let previewHTML = '';
                if (anexo.filename.toLowerCase().match(/\.(png|jpg|jpeg|gif|bmp|webp)$/)) {
                    previewHTML = '<img src="/uploads/' + anexo.filename + '" class="img-thumbnail" style="max-width: 100px; max-height: 100px; object-fit: cover;" alt="' + anexo.filename + '">';
                } else if (anexo.filename.toLowerCase().endsWith('.pdf')) {
                    previewHTML = '<div class="text-center"><i class="fas fa-file-pdf fa-4x text-danger mb-2"></i><br><small class="text-muted">Documento PDF</small></div>';
                } else {
                    previewHTML = '<div class="text-center"><i class="fas fa-file fa-4x text-secondary mb-2"></i><br><small class="text-muted">Arquivo</small></div>';
                }
                
                modalHTML += '<div class="col-md-4 mb-3">' +
                    '<div class="card h-100 anexo-card" style="cursor: pointer; transition: all 0.3s ease;" onclick="toggleAnexoSelection(\'anexo-' + anexo.id + '\')">' +
                        '<div class="card-body text-center p-3">' +
                            '<div class="form-check mb-3">' +
                                '<input class="form-check-input" type="checkbox" id="anexo-' + anexo.id + '" name="anexos_selecionados" value="' + anexo.id + '" checked>' +
                                '<label class="form-check-label font-weight-bold" for="anexo-' + anexo.id + '">' +
                                    '<i class="fas fa-check-circle text-success"></i> Incluir no Relatório' +
                                '</label>' +
                            '</div>' +
                            '<div class="anexo-preview mb-3" style="height: 120px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa; border-radius: 8px;">' +
                                previewHTML +
                            '</div>' +
                            '<div class="anexo-info">' +
                                '<h6 class="card-title mb-1" style="font-size: 0.9rem;">' + (anexo.original_filename || anexo.filename) + '</h6>' +
                                '<small class="text-muted">' + (anexo.filename.length > 20 ? anexo.filename.substring(0, 20) + '...' : anexo.filename) + '</small>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            
            modalHTML += '</div>' +
                '<div class="mt-3">' +
                    '<button type="button" class="btn btn-outline-primary btn-sm" onclick="selecionarTodosAnexos(' + entradaId + ', true)">' +
                        '<i class="fas fa-check-square"></i> Selecionar Todos' +
                    '</button>' +
                    '<button type="button" class="btn btn-outline-secondary btn-sm ml-2" onclick="selecionarTodosAnexos(' + entradaId + ', false)">' +
                        '<i class="fas fa-square"></i> Desmarcar Todos' +
                    '</button>' +
                '</div>' +
            '</div>';
        }
        
        modalHTML += '</form>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                        '<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>' +
                        '<button type="button" class="btn btn-primary" onclick="gerarRelatorio(' + entradaId + ')">Visualizar Relatório</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
        
        // Adicionar modal ao DOM
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Mostrar modal
        $('#relatorioModal-' + entradaId).modal('show');
        
        // Inicializar estado visual dos cards após o modal ser mostrado
        $('#relatorioModal-' + entradaId).on('shown.bs.modal', function () {
            initializeAnexoCards(entradaId);
        });
        
        // Remover modal do DOM quando fechado
        $('#relatorioModal-' + entradaId).on('hidden.bs.modal', function () {
            this.remove();
        });
    }
    

    function toggleAnexoSelection(checkboxId) {
        const checkbox = document.getElementById(checkboxId);
        const card = checkbox.closest('.anexo-card');
        
        checkbox.checked = !checkbox.checked;
        
        // Atualizar visual do card usando classes CSS
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    }
    
    function selecionarTodosAnexos(entradaId, selecionar) {
        const checkboxes = document.querySelectorAll('#relatorioModal-' + entradaId + ' input[name="anexos_selecionados"]');
        
        checkboxes.forEach(checkbox => {
            const card = checkbox.closest('.anexo-card');
            checkbox.checked = selecionar;
            
            // Atualizar visual do card usando classes CSS
            if (selecionar) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
     }
     
     function initializeAnexoCards(entradaId) {
         const checkboxes = document.querySelectorAll('#relatorioModal-' + entradaId + ' input[name="anexos_selecionados"]');
         
         checkboxes.forEach(checkbox => {
             const card = checkbox.closest('.anexo-card');
             
             // Aplicar classe 'selected' se o checkbox estiver marcado
             if (checkbox.checked) {
                 card.classList.add('selected');
             } else {
                 card.classList.remove('selected');
             }
         });
     }
      
      function criarModalRelatorio(dados) {
          const modalId = 'relatorioVisualizacao-' + dados.entradaId;
          
          // Remover modal existente se houver
          const modalExistente = document.getElementById(modalId);
          if (modalExistente) {
              modalExistente.remove();
          }
          
          // Formatar data para exibição
          const dataFormatada = new Date(dados.data + 'T00:00:00').toLocaleDateString('pt-BR');
          
          // Gerar HTML dos anexos
          let anexosHTML = '';
          if (dados.anexos && dados.anexos.length > 0) {
              anexosHTML = '<div class="anexos-section">';
              anexosHTML += '<div class="anexos-title" style="text-transform: uppercase;"><i class="fas fa-images"></i> Anexos do Pedido</div>';
              
              dados.anexos.forEach(function(anexo, index) {
                  if (anexo.filename.toLowerCase().match(/\.(png|jpg|jpeg|gif|bmp|webp)$/)) {
                      let imageClass = 'relatorio-imagem-editavel';
                      let containerClass = 'image-container-editavel';
                      
                      // Primeira imagem - layout especial
                      if (index === 0) {
                          imageClass += ' primeira-imagem';
                      }
                      
                      anexosHTML += '<div class="' + containerClass + '" data-image-index="' + index + '" style="position: relative; display: inline-block; margin: 10px; border: 2px dashed transparent; min-width: 200px; min-height: 150px;">';
                      anexosHTML += '<img src="/uploads/' + anexo.filename + '" class="' + imageClass + '" alt="' + anexo.filename + '" data-original-width="" data-original-height="" style="width: 300px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); object-fit: contain; cursor: move; user-select: none;" draggable="false">';
                      
                      // Controles de redimensionamento
                      anexosHTML += '<div class="resize-handles" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; display: none;">';
                      anexosHTML += '<div class="resize-handle resize-nw" style="position: absolute; top: -5px; left: -5px; width: 10px; height: 10px; background: #007bff; cursor: nw-resize; pointer-events: all;"></div>';
                      anexosHTML += '<div class="resize-handle resize-ne" style="position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: #007bff; cursor: ne-resize; pointer-events: all;"></div>';
                      anexosHTML += '<div class="resize-handle resize-sw" style="position: absolute; bottom: -5px; left: -5px; width: 10px; height: 10px; background: #007bff; cursor: sw-resize; pointer-events: all;"></div>';
                      anexosHTML += '<div class="resize-handle resize-se" style="position: absolute; bottom: -5px; right: -5px; width: 10px; height: 10px; background: #007bff; cursor: se-resize; pointer-events: all;"></div>';
                      anexosHTML += '</div>';
                      
                      anexosHTML += '</div>';
                  }
              });
              
              anexosHTML += '</div>';
          }
          
          let modalHTML = '<div class="modal fade" id="' + modalId + '" tabindex="-1" role="dialog" aria-labelledby="' + modalId + 'Label" aria-hidden="true">';
          modalHTML += '<div class="modal-dialog" style="max-width: 95vw; width: 95vw; height: 95vh; margin: 2.5vh auto;" role="document">';
          modalHTML += '<div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">';
          modalHTML += '<div class="modal-header">';
          modalHTML += '<h5 class="modal-title" id="' + modalId + 'Label" style="text-transform: uppercase;"><i class="fas fa-file-alt"></i> Relatório do Pedido</h5>';
          modalHTML += '<div class="ml-auto d-flex">';
          modalHTML += '<button type="button" class="btn btn-primary btn-sm mr-2" onclick="imprimirRelatorio(\'' + modalId + '\')" style="text-transform: uppercase;">';
          modalHTML += '<i class="fas fa-print"></i> Imprimir</button>';
          modalHTML += '<button type="button" class="btn btn-success btn-sm mr-2" onclick="baixarPDFRelatorio(\'' + modalId + '\', \'' + dados.numeroPedido + '\')" style="text-transform: uppercase;">';
          modalHTML += '<i class="fas fa-download"></i> Download PDF</button>';
          modalHTML += '<button type="button" class="btn btn-warning btn-sm mr-2" onclick="toggleEditMode(\'' + modalId + '\')" style="text-transform: uppercase;">';
          modalHTML += '<i class="fas fa-edit"></i> <span id="edit-mode-text-' + modalId + '">Editar</span></button>';
          modalHTML += '<button type="button" class="btn btn-info btn-sm mr-2" onclick="addTextBox(\'' + modalId + '\')" id="add-text-btn-' + modalId + '" style="text-transform: uppercase; display: none;">';
          modalHTML += '<i class="fas fa-font"></i> Adicionar Texto</button>';
          modalHTML += '<button type="button" class="btn btn-secondary btn-sm mr-2" onclick="resetLayout(\'' + modalId + '\')" id="reset-btn-' + modalId + '" style="text-transform: uppercase; display: none;">';
          modalHTML += '<i class="fas fa-undo"></i> Resetar</button>';
          modalHTML += '<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
          modalHTML += '<span aria-hidden="true">&times;</span></button></div></div>';
          modalHTML += '<div class="modal-body" id="' + modalId + '-content" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; background: #f5f5f5;">';
          modalHTML += '<div class="a4-page-container" style="display: flex; justify-content: center; padding: 20px;">';
          modalHTML += '<div class="relatorio-container a4-page" style="background: white; width: 210mm; min-height: 297mm; box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 6px 20px rgba(0,0,0,0.1); border: 1px solid #ddd; position: relative; overflow: visible;">';
          modalHTML += '<div class="a4-page-limits"></div>';
          modalHTML += '<div class="relatorio-content" style="padding: 15px 30px 30px 30px;">';
          modalHTML += '<div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">';
          
          // Data da Entrada
          modalHTML += '<div class="info-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #007bff;">';
          modalHTML += '<div class="info-label" style="font-weight: 600; color: #495057; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Data da Entrada</div>';
          modalHTML += '<div class="info-value" style="font-size: 1.3em; color: #212529; font-weight: 500; text-transform: uppercase;">' + dataFormatada + '</div></div>';
          
          // Número do Pedido
          modalHTML += '<div class="info-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #007bff;">';
          modalHTML += '<div class="info-label" style="font-weight: 600; color: #495057; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Número do Pedido</div>';
          modalHTML += '<div class="info-value" style="font-size: 1.3em; color: #212529; font-weight: 500; text-transform: uppercase;">' + dados.numeroPedido + '</div></div>';
          
          // Número do Cliente
          modalHTML += '<div class="info-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #007bff;">';
          modalHTML += '<div class="info-label" style="font-weight: 600; color: #495057; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Número do Cliente</div>';
          modalHTML += '<div class="info-value" style="font-size: 1.3em; color: #212529; font-weight: 500; text-transform: uppercase;">' + dados.numeroCliente + '</div></div>';
          
          // Nome do Cliente
          modalHTML += '<div class="info-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #007bff;">';
          modalHTML += '<div class="info-label" style="font-weight: 600; color: #495057; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Nome do Cliente</div>';
          modalHTML += '<div class="info-value" style="font-size: 1.3em; color: #212529; font-weight: 500; text-transform: uppercase;">' + dados.nomeCliente + '</div></div>';
          
          modalHTML += '</div>';
          
          // Obra (se existir)
          if (dados.obra) {
              modalHTML += '<div class="info-item" style="background: #f8f9fa; padding: 20px; border-radius: 5px; border-left: 4px solid #007bff; margin-bottom: 25px;">';
              modalHTML += '<div class="info-label" style="font-weight: 600; color: #495057; font-size: 1.0em; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Obra</div>';
              modalHTML += '<div class="info-value" style="font-size: 1.3em; color: #212529; font-weight: 500; text-transform: uppercase;">' + dados.obra + '</div></div>';
          }
          
          modalHTML += anexosHTML;
          modalHTML += '</div></div></div></div></div></div></div>';
          
          // Adicionar modal ao DOM
          document.body.insertAdjacentHTML('beforeend', modalHTML);
          
          // Mostrar modal
          $('#' + modalId).modal('show');
          

          
          // Remover modal do DOM quando fechado
          $('#' + modalId).on('hidden.bs.modal', function () {
              currentModalId = null;
              this.remove();
          });
      }
      
      function imprimirRelatorio(modalId) {
          
          const conteudo = document.getElementById(modalId + '-content').innerHTML;
          const janelaImpressao = window.open('', '_blank');
          
          janelaImpressao.document.write(
              '<!DOCTYPE html>' +
              '<html>' +
              '<head>' +
                  '<title>Relatório do Pedido</title>' +
                  '<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">' +
                  '<style>' +
                      '@media print {' +
                          'body { margin: 0; padding: 0; font-size: 12pt; text-transform: uppercase; }' +
                          '.container { max-width: none; width: 100%; margin: 0; padding: 0; }' +
                          '.relatorio-imagem { width: 100%; max-width: 19cm; max-height: 25cm; height: auto; display: block; margin: 0; border: 1px solid #ddd; object-fit: contain; page-break-inside: avoid; page-break-after: auto; }' +
                          '.relatorio-imagem.primeira-imagem { width: 100%; max-width: 19cm; max-height: 20cm; height: auto; display: block; margin: 0; border: 1px solid #ddd; object-fit: contain; page-break-inside: avoid; }' +
                          '.relatorio-imagem-editavel { object-fit: contain; page-break-inside: avoid; border-radius: 8px; }' +
                          '.image-container-editavel { page-break-inside: avoid; display: inline-block; position: relative; cursor: move; }' +
                          '.resize-handles { display: none; }' +
                          '.quebra-pagina-manual { page-break-before: always !important; height: 0 !important; overflow: hidden !important; margin: 0 !important; padding: 0 !important; }' +
                          '.quebra-pagina-manual .quebra-linha { display: none !important; }' +
                          '.quebra-pagina-manual .btn-remover-quebra { display: none !important; }' +
                          '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }' +
                          '.info-item { background: #f8f9fa !important; padding: 20px !important; border-radius: 5px; border-left: 4px solid #007bff !important; }' +
                          '.info-label { font-weight: 600 !important; color: #495057 !important; font-size: 1.0em !important; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px !important; }' +
                          '.info-value { font-size: 1.3em !important; color: #212529 !important; font-weight: 500 !important; text-transform: uppercase !important; }' +
                          '.relatorio-content { padding: 0 !important; }' +
                          '* { text-transform: uppercase !important; }' +
                      '}' +
                      '@page { size: A4; margin: 0; }' +
                      'body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; text-transform: uppercase; }' +
                  '</style>' +
              '</head>' +
              '<body>' +
                  conteudo +
                  '<script>' +
                      'window.onload = function() {' +
                          'window.print();' +
                          'window.onafterprint = function() {' +
                              'window.close();' +
                          '};' +
                      '};' +
                  '<\/script>' +
              '</body>' +
              '</html>'
          );
          
          janelaImpressao.document.close();
      }
      
      // Sistema de edição será reimplementado
      

      

       

               

                        




       


             



      
      // Novo sistema de edição de relatórios
      let editMode = {};
      let dragData = {};
      let textBoxCounter = 0;
      
      function toggleEditMode(modalId) {
          const isEditing = editMode[modalId] || false;
          editMode[modalId] = !isEditing;
          
          const editBtn = document.getElementById('edit-mode-text-' + modalId);
          const addTextBtn = document.getElementById('add-text-btn-' + modalId);
          const resetBtn = document.getElementById('reset-btn-' + modalId);
          const modal = document.getElementById(modalId);
          
          if (editMode[modalId]) {
              editBtn.textContent = 'Sair da Edição';
              addTextBtn.style.display = 'inline-block';
              resetBtn.style.display = 'inline-block';
              modal.classList.add('edit-mode');
              enableImageDragging(modalId);
          } else {
              editBtn.textContent = 'Editar';
              addTextBtn.style.display = 'none';
              resetBtn.style.display = 'none';
              modal.classList.remove('edit-mode');
              disableImageDragging(modalId);
          }
      }
      
      function enableImageDragging(modalId) {
          const images = document.querySelectorAll('#' + modalId + ' .relatorio-content img');
          images.forEach(img => {
              img.style.cursor = 'move';
              img.style.border = '2px dashed #007bff';
              img.draggable = false;
              
              img.addEventListener('mousedown', startImageDrag);
              addResizeHandles(img);
          });
      }
      
      function disableImageDragging(modalId) {
          const images = document.querySelectorAll('#' + modalId + ' .relatorio-content img');
          images.forEach(img => {
              img.style.cursor = 'default';
              img.style.border = 'none';
              img.removeEventListener('mousedown', startImageDrag);
              removeResizeHandles(img);
          });
      }
      
      function startImageDrag(e) {
          // Verificar se o clique foi em um handle de redimensionamento
          if (e.target.classList.contains('resize-handle')) {
              return;
          }
          
          // Verificar se o clique foi em um container de resize
          if (e.target.classList.contains('resize-container')) {
              return;
          }
          
          e.preventDefault();
          const img = e.target;
          const container = img.closest('.relatorio-content');
          
          // Obter posição atual da imagem usando offsetLeft/offsetTop para preservar posição original
          const currentLeft = parseInt(img.style.left) || img.offsetLeft;
          const currentTop = parseInt(img.style.top) || img.offsetTop;
          
          const containerRect = container.getBoundingClientRect();
          
          dragData.element = img;
          dragData.offsetX = e.clientX - containerRect.left - currentLeft;
          dragData.offsetY = e.clientY - containerRect.top - currentTop;
          dragData.container = container;
          
          // Garantir que a imagem tenha posição absoluta
          if (img.style.position !== 'absolute') {
              img.style.position = 'absolute';
              img.style.left = currentLeft + 'px';
              img.style.top = currentTop + 'px';
          }
          img.style.zIndex = '1000';
          
          document.addEventListener('mousemove', dragImage);
          document.addEventListener('mouseup', stopImageDrag);
      }
      
      function dragImage(e) {
          if (!dragData.element) return;
          
          const container = dragData.container;
          const containerRect = container.getBoundingClientRect();
          
          let newX = e.clientX - containerRect.left - dragData.offsetX;
          let newY = e.clientY - containerRect.top - dragData.offsetY;
          
          // Permitir movimento livre - apenas evitar que a imagem saia completamente da área visível
          // Manter pelo menos 50px da imagem visível em cada direção
          const minVisible = 50;
          newX = Math.max(-dragData.element.offsetWidth + minVisible, Math.min(newX, container.clientWidth - minVisible));
          newY = Math.max(-dragData.element.offsetHeight + minVisible, Math.min(newY, container.clientHeight - minVisible));
          
          dragData.element.style.left = newX + 'px';
          dragData.element.style.top = newY + 'px';
          
          // Atualizar posição dos handles de redimensionamento
          updateResizeHandles(dragData.element);
      }
      
      function stopImageDrag() {
          document.removeEventListener('mousemove', dragImage);
          document.removeEventListener('mouseup', stopImageDrag);
          dragData = {};
      }
      
      function addResizeHandles(img) {
          // Remove handles existentes
          removeResizeHandles(img);
          
          // Inicializar array de handles
          img.resizeHandles = [];
          
          // Garantir que a imagem tenha posição absoluta
          const relativeContainer = img.closest('.relatorio-content');
          
          if (!img.style.position || img.style.position !== 'absolute') {
              // Preservar a posição original da imagem
              const containerStyle = window.getComputedStyle(relativeContainer);
              
              // Obter padding do container para ajustar a posição
              const containerPaddingLeft = parseInt(containerStyle.paddingLeft) || 0;
              const containerPaddingTop = parseInt(containerStyle.paddingTop) || 0;
              
              // Calcular posição real da imagem considerando o padding do container
              const imgLeft = img.offsetLeft - containerPaddingLeft;
              const imgTop = img.offsetTop - containerPaddingTop;
              
              img.style.position = 'absolute';
              img.style.left = Math.max(0, imgLeft) + 'px';
              img.style.top = Math.max(0, imgTop) + 'px';
              
              // Preservar dimensões originais se não estiverem definidas
              if (!img.style.width) {
                  img.style.width = img.offsetWidth + 'px';
              }
              if (!img.style.height) {
                  img.style.height = img.offsetHeight + 'px';
              }
          }
          
          // Adicionar borda de edição diretamente na imagem
          img.style.border = '2px dashed #007bff';
          
          // Criar array para armazenar handles
          img.resizeHandles = [];
          
          // Criar handles de redimensionamento
          const handles = [
              {pos: 'nw', cursor: 'nw-resize'},
              {pos: 'ne', cursor: 'ne-resize'},
              {pos: 'sw', cursor: 'sw-resize'},
              {pos: 'se', cursor: 'se-resize'},
              {pos: 'n', cursor: 'n-resize'},
              {pos: 's', cursor: 's-resize'},
              {pos: 'e', cursor: 'e-resize'},
              {pos: 'w', cursor: 'w-resize'}
          ];
          
          handles.forEach(handle => {
              const handleEl = document.createElement('div');
              handleEl.className = `resize-handle resize-${handle.pos}`;
              handleEl.style.cssText = `
                  position: absolute;
                  background: #007bff;
                  border: 2px solid white;
                  width: 10px;
                  height: 10px;
                  cursor: ${handle.cursor};
                  pointer-events: all;
                  z-index: 9999;
              `;
              
              // Posicionar handle em relação à imagem
              updateHandlePosition(handleEl, handle.pos, img);
              
              handleEl.addEventListener('mousedown', (e) => startImageResize(e, img, handle.pos));
              relativeContainer.appendChild(handleEl);
              img.resizeHandles.push(handleEl);
          });
          
      }
      
      function updateHandlePosition(handleEl, position, img) {
          // Obter posição real da imagem
          const imgRect = img.getBoundingClientRect();
          const container = img.closest('.relatorio-content');
          const containerRect = container.getBoundingClientRect();
          
          // Calcular posição relativa ao container
          const imgLeft = imgRect.left - containerRect.left;
          const imgTop = imgRect.top - containerRect.top;
          const imgWidth = img.offsetWidth;
          const imgHeight = img.offsetHeight;
          
          switch(position) {
              case 'nw':
                  handleEl.style.left = (imgLeft - 5) + 'px';
                  handleEl.style.top = (imgTop - 5) + 'px';
                  break;
              case 'ne':
                  handleEl.style.left = (imgLeft + imgWidth - 5) + 'px';
                  handleEl.style.top = (imgTop - 5) + 'px';
                  break;
              case 'sw':
                  handleEl.style.left = (imgLeft - 5) + 'px';
                  handleEl.style.top = (imgTop + imgHeight - 5) + 'px';
                  break;
              case 'se':
                  handleEl.style.left = (imgLeft + imgWidth - 5) + 'px';
                  handleEl.style.top = (imgTop + imgHeight - 5) + 'px';
                  break;
              case 'n':
                  handleEl.style.left = (imgLeft + imgWidth/2 - 5) + 'px';
                  handleEl.style.top = (imgTop - 5) + 'px';
                  break;
              case 's':
                  handleEl.style.left = (imgLeft + imgWidth/2 - 5) + 'px';
                  handleEl.style.top = (imgTop + imgHeight - 5) + 'px';
                  break;
              case 'e':
                  handleEl.style.left = (imgLeft + imgWidth - 5) + 'px';
                  handleEl.style.top = (imgTop + imgHeight/2 - 5) + 'px';
                  break;
              case 'w':
                  handleEl.style.left = (imgLeft - 5) + 'px';
                  handleEl.style.top = (imgTop + imgHeight/2 - 5) + 'px';
                  break;
          }
      }
      
      function removeResizeHandles(img) {
          if (img.resizeHandles) {
              img.resizeHandles.forEach(handle => handle.remove());
              img.resizeHandles = [];
          }
          // Remover borda de edição
          img.style.border = 'none';
      }
      
      function updateResizeHandles(img) {
          if (img.resizeHandles && img.resizeHandles.length > 0) {
              img.resizeHandles.forEach((handle, index) => {
                  const positions = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];
                  updateHandlePosition(handle, positions[index], img);
              });
          }
      }
      
      function startImageResize(e, img, direction) {
          e.preventDefault();
          e.stopPropagation();
          
          const startX = e.clientX;
          const startY = e.clientY;
          const startWidth = img.offsetWidth;
          const startHeight = img.offsetHeight;
          const startLeft = parseInt(img.style.left) || 0;
          const startTop = parseInt(img.style.top) || 0;
          const aspectRatio = startWidth / startHeight;
          
          function doResize(e) {
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              
              let newWidth = startWidth;
              let newHeight = startHeight;
              let newLeft = startLeft;
              let newTop = startTop;
              
              // Calcular novas dimensões baseado na direção
              switch(direction) {
                  case 'se':
                      newWidth = startWidth + deltaX;
                      newHeight = startHeight + deltaY;
                      break;
                  case 'sw':
                      newWidth = startWidth - deltaX;
                      newHeight = startHeight + deltaY;
                      newLeft = startLeft + deltaX;
                      break;
                  case 'ne':
                      newWidth = startWidth + deltaX;
                      newHeight = startHeight - deltaY;
                      newTop = startTop + deltaY;
                      break;
                  case 'nw':
                      newWidth = startWidth - deltaX;
                      newHeight = startHeight - deltaY;
                      newLeft = startLeft + deltaX;
                      newTop = startTop + deltaY;
                      break;
                  case 'e':
                      newWidth = startWidth + deltaX;
                      newHeight = newWidth / aspectRatio;
                      break;
                  case 'w':
                      newWidth = startWidth - deltaX;
                      newHeight = newWidth / aspectRatio;
                      newLeft = startLeft + deltaX;
                      break;
                  case 's':
                      newHeight = startHeight + deltaY;
                      newWidth = newHeight * aspectRatio;
                      break;
                  case 'n':
                      newHeight = startHeight - deltaY;
                      newWidth = newHeight * aspectRatio;
                      newTop = startTop + deltaY;
                      break;
              }
              
              // Aplicar dimensões mínimas após o cálculo
              newWidth = Math.max(50, newWidth);
              newHeight = Math.max(50, newHeight);
              

              
              // Validar limites do container com mais flexibilidade
              const relativeContainer = img.closest('.relatorio-content');
              const containerWidth = relativeContainer.clientWidth;
              const containerHeight = relativeContainer.clientHeight;
              
              // Permitir que a imagem seja maior que o container, mas manter posição mínima
              if (newLeft < 0) {
                  newLeft = 0;
              }
              if (newTop < 0) {
                  newTop = 0;
              }
              
              // Limitar apenas se a imagem ficar completamente fora do container
              if (newLeft > containerWidth - 50) {
                  newLeft = containerWidth - 50;
              }
              if (newTop > containerHeight - 50) {
                  newTop = containerHeight - 50;
              }
              
              // Garantir dimensões mínimas
              newWidth = Math.max(50, newWidth);
              newHeight = Math.max(50, newHeight);
              
              // Permitir dimensões maiores que o container para flexibilidade de edição
              // Removendo limites máximos para permitir aumento livre das imagens
              
              // Aplicar novas dimensões
              img.style.width = newWidth + 'px';
              img.style.height = newHeight + 'px';
              img.style.left = newLeft + 'px';
              img.style.top = newTop + 'px';
              
              // Atualizar posição dos handles
              updateResizeHandles(img);
          }
          
          function stopResize() {
              document.removeEventListener('mousemove', doResize);
              document.removeEventListener('mouseup', stopResize);
          }
          
          document.addEventListener('mousemove', doResize);
          document.addEventListener('mouseup', stopResize);
      }
      
      function addTextBox(modalId) {
          const container = document.querySelector('#' + modalId + ' .relatorio-content');
          textBoxCounter++;
          
          const textBox = document.createElement('div');
          textBox.className = 'editable-text-box';
          textBox.id = 'textbox-' + modalId + '-' + textBoxCounter;
          textBox.style.cssText = `
              position: absolute;
              top: 50px;
              left: 50px;
              min-width: 200px;
              min-height: 30px;
              padding: 10px;
              border: 2px dashed #007bff;
              background: rgba(255, 255, 255, 0.9);
              cursor: move;
              z-index: 100;
              font-family: Arial, sans-serif;
              font-size: 14px;
          `;
          
          const textContent = document.createElement('div');
          textContent.contentEditable = true;
          textContent.textContent = 'Clique para editar texto';
          textContent.style.cssText = `
              outline: none;
              cursor: text;
          `;
          
          const removeBtn = document.createElement('button');
          removeBtn.innerHTML = '×';
          removeBtn.style.cssText = `
              position: absolute;
              top: -10px;
              right: -10px;
              width: 20px;
              height: 20px;
              border: none;
              border-radius: 50%;
              background: #dc3545;
              color: white;
              cursor: pointer;
              font-size: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
          `;
          
          removeBtn.onclick = function(e) {
              e.stopPropagation();
              if (confirm('Remover esta caixa de texto?')) {
                  textBox.remove();
              }
          };
          
          textBox.appendChild(textContent);
          textBox.appendChild(removeBtn);
          container.appendChild(textBox);
          
          // Adicionar eventos de arrastar
          textBox.addEventListener('mousedown', function(e) {
              if (e.target === textContent) return;
              startTextBoxDrag(e, textBox);
          });
          
          // Focar no texto
          textContent.focus();
          textContent.select();
      }
      
      function startTextBoxDrag(e, textBox) {
          e.preventDefault();
          const rect = textBox.getBoundingClientRect();
          const container = textBox.closest('.relatorio-content');
          const containerRect = container.getBoundingClientRect();
          
          dragData.element = textBox;
          dragData.offsetX = e.clientX - rect.left;
          dragData.offsetY = e.clientY - rect.top;
          dragData.container = container;
          dragData.containerRect = containerRect;
          
          document.addEventListener('mousemove', dragTextBox);
          document.addEventListener('mouseup', stopTextBoxDrag);
      }
      
      function dragTextBox(e) {
          if (!dragData.element) return;
          
          const container = dragData.container;
          const containerRect = dragData.containerRect;
          
          let newX = e.clientX - containerRect.left - dragData.offsetX + container.scrollLeft;
          let newY = e.clientY - containerRect.top - dragData.offsetY + container.scrollTop;
          
          // Permitir movimento livre - apenas evitar que o elemento saia completamente da área visível
          // Manter pelo menos 50px do elemento visível em cada direção
          const minVisible = 50;
          newX = Math.max(-dragData.element.offsetWidth + minVisible, Math.min(newX, container.scrollWidth - minVisible));
          newY = Math.max(-dragData.element.offsetHeight + minVisible, Math.min(newY, container.scrollHeight - minVisible));
          
          dragData.element.style.left = newX + 'px';
          dragData.element.style.top = newY + 'px';
      }
      
      function stopTextBoxDrag() {
          document.removeEventListener('mousemove', dragTextBox);
          document.removeEventListener('mouseup', stopTextBoxDrag);
          dragData = {};
      }
      
      function resetLayout(modalId) {
          if (confirm('Resetar todas as alterações de layout?')) {
              // Resetar imagens
              const images = document.querySelectorAll('#' + modalId + ' .relatorio-content img');
              images.forEach(img => {
                  // Remover handles de redimensionamento
                  removeResizeHandles(img);
                  
                  // Resetar estilos
                  img.style.position = '';
                  img.style.left = '';
                  img.style.top = '';
                  img.style.zIndex = '';
                  img.style.width = '';
                  img.style.height = '';
                  img.style.cursor = 'default';
                  img.style.border = 'none';
                  
                  // Remover event listeners
                  img.removeEventListener('mousedown', startImageDrag);
              });
              
              // Remover caixas de texto
              const textBoxes = document.querySelectorAll('#' + modalId + ' .editable-text-box');
              textBoxes.forEach(box => box.remove());
              
              // Remover containers de redimensionamento órfãos
              const resizeContainers = document.querySelectorAll('#' + modalId + ' .image-resize-container');
              resizeContainers.forEach(container => container.remove());
              
              textBoxCounter = 0;
              
              // Desabilitar modo de edição
              const modal = document.getElementById(modalId);
              modal.classList.remove('edit-mode');
              
              // Resetar botões
              const editBtn = document.querySelector('#' + modalId + ' .edit-btn');
              const addTextBtn = document.querySelector('#' + modalId + ' .add-text-btn');
              const resetBtn = document.querySelector('#' + modalId + ' .reset-btn');
              
              if (editBtn) editBtn.textContent = 'Editar';
              if (addTextBtn) addTextBtn.style.display = 'none';
              if (resetBtn) resetBtn.style.display = 'none';
          }
      }
      
         function baixarPDFRelatorio(modalId, numeroPedido) {
          // Carregar bibliotecas se não estiverem disponíveis
          if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
              const script1 = document.createElement('script');
              script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
              document.head.appendChild(script1);
              
              const script2 = document.createElement('script');
              script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
              document.head.appendChild(script2);
              
              script2.onload = function() {
                  setTimeout(() => gerarPDF(modalId, numeroPedido), 500);
              };
          } else {
              gerarPDF(modalId, numeroPedido);
          }
      }
      
      function gerarPDF(modalId, numeroPedido) {
          
          const elemento = document.querySelector('#' + modalId + ' .relatorio-container');
          const quebrasManual = elemento.querySelectorAll('.quebra-pagina-manual');
          
          if (quebrasManual.length === 0) {
              // Método original se não há quebras manuais
              html2canvas(elemento, {
                  scale: 2,
                  useCORS: true,
                  allowTaint: true
              }).then(canvas => {
                  const { jsPDF } = window.jspdf;
                  const imgData = canvas.toDataURL('image/png');
                  const pdf = new jsPDF('p', 'mm', 'a4');
                  
                  const imgWidth = 210;
                  const pageHeight = 295;
                  const imgHeight = (canvas.height * imgWidth) / canvas.width;
                  let heightLeft = imgHeight;
                  let position = 0;
                  
                  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                  heightLeft -= pageHeight;
                  
                  while (heightLeft >= 0) {
                      position = heightLeft - imgHeight;
                      pdf.addPage();
                      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                      heightLeft -= pageHeight;
                  }
                  
                  pdf.save('relatorio-pedido-' + numeroPedido + '.pdf');
              }).catch(error => {
                  console.error('Erro ao gerar PDF:', error);
                  alert('Erro ao gerar PDF. Tente usar a função de impressão.');
              });
          } else {
              // Método com quebras de página manuais
              gerarPDFComQuebras(elemento, numeroPedido, quebrasManual);
          }
      }
      
      function gerarPDFComQuebras(elemento, numeroPedido, quebrasManual) {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          let paginaAtual = 0;
          
          // Criar seções baseadas nas quebras de página
          const secoes = [];
          let conteudoAtual = [];
          
          Array.from(elemento.children).forEach(child => {
              if (child.classList.contains('quebra-pagina-manual')) {
                  if (conteudoAtual.length > 0) {
                      secoes.push(conteudoAtual);
                      conteudoAtual = [];
                  }
              } else {
                  conteudoAtual.push(child);
              }
          });
          
          // Adicionar última seção se houver conteúdo
          if (conteudoAtual.length > 0) {
              secoes.push(conteudoAtual);
          }
          
          // Processar cada seção
          processarSecoesPDF(secoes, 0, pdf, numeroPedido);
      }
      
      function processarSecoesPDF(secoes, indice, pdf, numeroPedido) {
          if (indice >= secoes.length) {
              pdf.save('relatorio-pedido-' + numeroPedido + '.pdf');
              return;
          }
          
          // Criar container temporário para a seção atual
          const containerTemp = document.createElement('div');
          containerTemp.style.cssText = 'position: absolute; left: -9999px; top: -9999px; background: white; padding: 20px;';
          
          secoes[indice].forEach(elemento => {
              containerTemp.appendChild(elemento.cloneNode(true));
          });
          
          document.body.appendChild(containerTemp);
          
          html2canvas(containerTemp, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: '#ffffff'
          }).then(canvas => {
              if (indice > 0) {
                  pdf.addPage();
              }
              
              const imgData = canvas.toDataURL('image/png');
              const imgWidth = 210;
              const imgHeight = (canvas.height * imgWidth) / canvas.width;
              
              pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
              
              // Remover container temporário
              document.body.removeChild(containerTemp);
              
              // Processar próxima seção
              processarSecoesPDF(secoes, indice + 1, pdf, numeroPedido);
          }).catch(error => {
              console.error('Erro ao processar seção:', error);
              document.body.removeChild(containerTemp);
              processarSecoesPDF(secoes, indice + 1, pdf, numeroPedido);
          });
      }
      
      // Funções para drag and drop de anexos
      function allowDrop(ev) {
          ev.preventDefault();
      }
      
      function dragEnter(ev) {
          ev.preventDefault();
          ev.currentTarget.classList.add('drag-over');
      }
      
      function dragLeave(ev) {
          ev.preventDefault();
          // Só remove a classe se realmente saiu do elemento
          if (!ev.currentTarget.contains(ev.relatedTarget)) {
              ev.currentTarget.classList.remove('drag-over');
          }
      }
      
      function dropAnexo(ev, entradaId) {
          ev.preventDefault();
          ev.currentTarget.classList.remove('drag-over');
          
          const files = ev.dataTransfer.files;
          if (files.length > 0) {
              uploadAnexos(files, entradaId, ev.currentTarget);
          }
      }
      
      function uploadAnexos(files, entradaId, targetElement) {
          const formData = new FormData();
          
          // Adiciona todos os arquivos ao FormData
          for (let i = 0; i < files.length; i++) {
              formData.append('anexos', files[i]);
          }
          
          // Adiciona o ID da entrada
          formData.append('entrada_id', entradaId);
          
          // Mostra estado de upload
          targetElement.classList.add('uploading');
          const originalContent = targetElement.innerHTML;
          targetElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          // Faz o upload via AJAX
          fetch('/upload_anexos', {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Atualiza a interface
                  updateAnexosDisplay(entradaId, data.total_anexos);
                  
                  // Mostra notificação de sucesso
                  showNotification('Anexos enviados com sucesso!', 'success');
              } else {
                  throw new Error(data.message || 'Erro no upload');
              }
          })
          .catch(error => {
              console.error('Erro no upload:', error);
              showNotification('Erro ao enviar anexos: ' + error.message, 'error');
              
              // Restaura o conteúdo original
              targetElement.innerHTML = originalContent;
          })
          .finally(() => {
              targetElement.classList.remove('uploading');
          });
      }
      
      function updateAnexosDisplay(entradaId, totalAnexos) {
          // Atualiza todas as caixas de anexos para esta entrada
          const anexosBoxes = document.querySelectorAll(`[data-entrada-id="${entradaId}"]`);
          
          anexosBoxes.forEach(box => {
              const countSpan = box.querySelector('.anexos-count');
              const icon = box.querySelector('i');
              
              if (totalAnexos > 0) {
                  box.classList.remove('anexos-empty');
                  box.setAttribute('data-toggle', 'modal');
                  box.setAttribute('data-target', `#galeriaAnexos-${entradaId}`);
                  box.title = 'Clique para ver anexos ou arraste arquivos aqui';
                  
                  icon.className = 'fas fa-paperclip';
                  countSpan.textContent = totalAnexos;
              } else {
                  box.classList.add('anexos-empty');
                  box.removeAttribute('data-toggle');
                  box.removeAttribute('data-target');
                  box.title = 'Arraste arquivos aqui para adicionar anexos';
                  
                  icon.className = 'fas fa-plus';
                  countSpan.textContent = '0';
              }
          });
      }
      
      function showNotification(message, type) {
          // Cria elemento de notificação
          const notification = document.createElement('div');
          notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-toast`;
          notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 9999;
              min-width: 300px;
              animation: slideInRight 0.3s ease;
          `;
          notification.innerHTML = `
              <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
              ${message}
              <button type="button" class="close ml-2" onclick="this.parentElement.remove()">
                  <span>&times;</span>
              </button>
          `;
          
          document.body.appendChild(notification);
          
          // Remove automaticamente após 5 segundos
          setTimeout(() => {
              if (notification.parentElement) {
                  notification.style.animation = 'slideOutRight 0.3s ease';
                  setTimeout(() => notification.remove(), 300);
              }
          }, 5000);
      }
      
      // Event listeners para detectar mudanças nos filtros
      document.addEventListener('DOMContentLoaded', function() {
          const searchInput = document.getElementById('q');
          const statusSelect = document.getElementById('status');
          const filterForm = document.querySelector('form[method="GET"]');
          
          // Função para limpar a flag quando filtros são aplicados
          function clearSkipTableUpdateFlag() {
              if (window.PAINEL_SYSTEM) {
                  window.PAINEL_SYSTEM.skipTableUpdate = false;
                  console.log('Flag skipTableUpdate limpa - tabelas podem ser atualizadas novamente');
              }
          }
          
          // Limpa a flag quando o formulário é submetido
          if (filterForm) {
              filterForm.addEventListener('submit', clearSkipTableUpdateFlag);
          }
          
          // Limpa a flag quando o botão de limpar é clicado
           const clearButton = document.querySelector("a[href='{{ url_for('painel_controle') }}']");
           if (clearButton) {
               clearButton.addEventListener('click', clearSkipTableUpdateFlag);
           }
      });
      </script>

<style>
    :root {
        --bg-primary: #2d3748;
        --bg-secondary: #2d3748;
        --border-color: #4a5568;
        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
        --hover-bg: #1a365d;
        --hover-border: #4299e1;
        --input-bg: #2d3748;
        --input-border: #4a5568;
        --input-text: #e2e8f0;
    }
    
    [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --border-color: #dee2e6;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --hover-bg: #e3f2fd;
        --hover-border: #007bff;
        --input-bg: #ffffff;
        --input-border: #ced4da;
        --input-text: #495057;
    }
    
    /* Estilos para campos de formulário */
    .form-control {
        background-color: var(--input-bg) !important;
        border-color: var(--input-border) !important;
        color: var(--input-text) !important;
    }
    
    .form-control:focus {
        background-color: var(--input-bg) !important;
        border-color: var(--hover-border) !important;
        color: var(--input-text) !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }
    
    .form-control::placeholder {
        color: var(--text-secondary) !important;
    }
    
    /* Labels */
    label {
        color: var(--text-primary) !important;
    }
    
    /* Cards */
    .card {
        background-color: var(--bg-primary) !important;
        border-color: var(--border-color) !important;
    }
    
    .card-header {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .card-body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    /* Tabelas */
    .table {
        color: var(--text-primary) !important;
    }
    
    .table th {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .table td {
        background-color: var(--bg-primary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: var(--bg-secondary) !important;
    }
    
    /* Modal */
    .modal-content {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-header {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }
    
    .modal-footer {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }
    
    /* Estilos para página A4 */
    .a4-page-container {
        background: #f5f5f5;
        min-height: 100%;
        padding: 20px;
    }
    
    .a4-page {
        width: 210mm !important;
        min-height: 297mm !important;
        max-width: 210mm !important;
        background: white !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 6px 20px rgba(0,0,0,0.1) !important;
        border: 1px solid #ddd !important;
        margin: 0 auto !important;
        position: relative !important;
        overflow: visible !important;
    }
    
    .a4-page::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        border: 2px solid #007bff;
        border-radius: 2px;
        opacity: 0.3;
        pointer-events: none;
        z-index: 1;
    }
    
    .a4-page .relatorio-content {
        position: relative;
        z-index: 2;
        padding: 10mm !important;
        min-height: calc(297mm - 20mm);
    }
    
    /* Limites visuais para imagens - removidos para permitir redimensionamento livre */
    .image-container-editavel {
        /* max-width removido para permitir redimensionamento livre */
    }
    
    .relatorio-imagem-editavel {
        /* max-width e height auto removidos para permitir redimensionamento livre */
    }
    
    /* Indicador de limites da página */
    .a4-page-limits {
        position: absolute;
        top: 20mm;
        left: 20mm;
        right: 20mm;
        bottom: 20mm;
        border: 1px dashed #ccc;
        pointer-events: none;
        z-index: 1;
    }
</style>

{% endblock %}