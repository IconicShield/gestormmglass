{% extends 'base.html' %}

{% block content %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Painel de Controle</h1>
        <div>
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#importarEntradasModal">
                <i class="fas fa-file-upload"></i> Importar .xlsx
            </button>
            <a href="{{ url_for('exportar_painel') }}" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar .xlsx</a>
            <a href="{{ url_for('pedidos_arquivados') }}" class="btn btn-outline-secondary"><i class="fas fa-archive"></i> Ver Arquivados</a>
            <a href="{{ url_for('nova_entrada') }}" class="btn btn-primary shadow-sm"><i class="fas fa-plus fa-sm"></i> Nova Entrada</a>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Pedidos</div>
                            <div id="dash-pedidos-total" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.total }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-box fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Pedidos Não Iniciados</div>
                            <div id="dash-pedidos-nao-iniciado" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.nao_iniciado }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hourglass-start fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pedidos em Andamento</div>
                            <div id="dash-pedidos-em-andamento" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.em_andamento }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-tasks fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Pedidos Concluídos</div>
                            <div id="dash-pedidos-concluido" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.pedidos.concluido }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total de Orçamentos</div>
                            <div id="dash-orcamentos-total" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.total }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-file-invoice fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Orçamentos Não Iniciados</div>
                            <div id="dash-orcamentos-nao-iniciado" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.nao_iniciado }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-hourglass-start fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Orçamentos em Andamento</div>
                            <div id="dash-orcamentos-em-andamento" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.em_andamento }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-tasks fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Orçamentos Concluídos</div>
                            <div id="dash-orcamentos-concluido" class="h5 mb-0 font-weight-bold text-gray-800">{{ dashboard.orcamentos.concluido }}</div>
                        </div>
                        <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body py-2">
            <form method="GET" action="{{ url_for('painel_controle') }}">
                <div class="form-row align-items-end">
                    <div class="col-md-6"><div class="form-group mb-0"><label for="q" class="small">Buscar (N°, Cliente, Descrição)</label><input type="text" class="form-control form-control-sm" id="q" name="q" value="{{ search_query }}"></div></div>
                    <div class="col-md-4"><div class="form-group mb-0"><label for="status" class="small">Filtrar por Status</label><select id="status" name="status" class="form-control form-control-sm"><option value="">Todos</option><option value="Não iniciado" {% if selected_status == 'Não iniciado' %}selected{% endif %}>Não iniciado</option><option value="Em andamento" {% if selected_status == 'Em andamento' %}selected{% endif %}>Em andamento</option><option value="Concluído" {% if selected_status == 'Concluído' %}selected{% endif %}>Concluído</option></select></div></div>
                    <div class="col-md-1"><div class="form-group mb-0"><button type="submit" class="btn btn-primary btn-sm btn-block" title="Filtrar"><i class="fas fa-filter"></i></button></div></div>
                    <div class="col-md-1"><div class="form-group mb-0"><a href="{{ url_for('painel_controle') }}" class="btn btn-secondary btn-sm btn-block" title="Limpar"><i class="fas fa-eraser"></i></a></div></div>
                </div>
            </form>
        </div>
    </div>

    <h3>Pedidos</h3>
    <table class="table table-hover table-sm shadow-sm rounded table-uppercase">
        <thead class="thead-light">
            <tr><th>Data</th><th>N° Pedido</th><th>N° Cliente</th><th>Cliente</th><th>Obra</th><th>Status</th><th>Descrição</th><th>Observações</th><th>Anexos</th><th>Ações</th></tr>
        </thead>
        <tbody>
            {% for entrada in pedidos %}
            <tr>
                <td>{{ entrada.data_registro.strftime('%d/%m/%Y') }}</td>
                <td>
                    <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#detalhesModal-{{ entrada.id }}">
                        {{ entrada.numero_pedido }}
                    </button>
                </td>
                <td>
                    {% if entrada.cliente %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-{{ entrada.cliente.id }}">
                            {{ entrada.cliente.numero_cliente }}
                        </button>
                    {% else %}
                        <a href="{{ url_for('novo_cliente', tipo='rapido', nome=entrada.cliente_nome_temp) }}" class="btn btn-success btn-sm" title="Cadastrar este cliente">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </td>
                <td>{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</td>
                <td>{{ entrada.obra or '-' }}</td>
                <td>{% set status_color = 'secondary' %}{% if entrada.status == 'Concluído' %}{% set status_color = 'success' %}{% elif entrada.status == 'Em andamento' %}{% set status_color = 'warning' %}{% elif entrada.status == 'Não iniciado' %}{% set status_color = 'danger' %}{% endif %}<div class="dropdown"><button class="btn btn-{{ status_color }} btn-sm dropdown-toggle" type="button" id="status-btn-{{ entrada.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ entrada.status }}</button><div class="dropdown-menu" aria-labelledby="status-btn-{{ entrada.id }}"><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Não iniciado">Não iniciado</a><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Em andamento">Em andamento</a><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Concluído">Concluído</a></div></div></td>
                <td>{{ (entrada.descricao or '') | truncate(20) }}</td>
                <td>{{ (entrada.observacoes or '') | truncate(20) or '-' }}</td>
                <td>
                    {% if entrada.anexos %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-toggle="modal" data-target="#galeriaAnexos-{{ entrada.id }}">
                            <i class="fas fa-paperclip mr-1"></i> Ver ({{ entrada.anexos|length }})
                        </button>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td><form action="{{ url_for('arquivar_entrada', id=entrada.id) }}" method="post" style="display: inline;"><button type="submit" class="btn btn-xs btn-secondary" title="Arquivar"><i class="fas fa-archive"></i></button></form><a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-xs btn-info" title="Editar"><i class="fas fa-edit"></i></a><form action="{{ url_for('excluir_entrada', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem a certeza?');"><button type="submit" class="btn btn-xs btn-danger" title="Excluir"><i class="fas fa-trash-alt"></i></button></form></td>
            </tr>
            {% else %}
            <tr><td colspan="10" class="text-center">Nenhum pedido ativo encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    <br>
    <h3>Orçamentos</h3>
    <table class="table table-hover table-sm shadow-sm rounded table-uppercase">
        <thead class="thead-light">
            <tr><th>Data</th><th>N° Pedido</th><th>N° Cliente</th><th>Cliente</th><th>Obra</th><th>Status</th><th>Descrição</th><th>Observações</th><th>Anexos</th><th>Ações</th></tr>
        </thead>
        <tbody>
            {% for entrada in orcamentos %}
            <tr>
                <td>{{ entrada.data_registro.strftime('%d/%m/%Y') }}</td>
                <td><button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#detalhesModal-{{ entrada.id }}">{% if entrada.numero_pedido > 1000000000 %}<i class="fas fa-search"></i> Detalhes{% else %}{{ entrada.numero_pedido }}{% endif %}</button></td>
                <td>
                    {% if entrada.cliente %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" style="color: var(--text-color);" data-toggle="modal" data-target="#clienteDetalhesModal-{{ entrada.cliente.id }}">
                            {{ entrada.cliente.numero_cliente }}
                        </button>
                    {% else %}
                        <a href="{{ url_for('novo_cliente', tipo='rapido', nome=entrada.cliente_nome_temp) }}" class="btn btn-success btn-sm" title="Cadastrar este cliente">
                            <i class="fas fa-plus"></i>
                        </a>
                    {% endif %}
                </td>
                <td>{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</td>
                <td>{{ entrada.obra or '-' }}</td>
                <td>{% set status_color = 'secondary' %}{% if entrada.status == 'Concluído' %}{% set status_color = 'success' %}{% elif entrada.status == 'Em andamento' %}{% set status_color = 'warning' %}{% elif entrada.status == 'Não iniciado' %}{% set status_color = 'danger' %}{% endif %}<div class="dropdown"><button class="btn btn-{{ status_color }} btn-sm dropdown-toggle" type="button" id="status-btn-{{ entrada.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ entrada.status }}</button><div class="dropdown-menu" aria-labelledby="status-btn-{{ entrada.id }}"><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Não iniciado">Não iniciado</a><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Em andamento">Em andamento</a><a class="dropdown-item status-option" href="#" data-id="{{ entrada.id }}" data-status="Concluído">Concluído</a></div></div></td>
                <td>{{ (entrada.descricao or '') | truncate(20) }}</td>
                <td>{{ (entrada.observacoes or '') | truncate(20) or '-' }}</td>
                <td>
                    {% if entrada.anexos %}
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-toggle="modal" data-target="#galeriaAnexos-{{ entrada.id }}">
                            <i class="fas fa-paperclip mr-1"></i> ({{ entrada.anexos|length }})
                        </button>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td><form action="{{ url_for('arquivar_entrada', id=entrada.id) }}" method="post" style="display: inline;"><button type="submit" class="btn btn-xs btn-secondary" title="Arquivar"><i class="fas fa-archive"></i></button></form><form action="{{ url_for('converter_para_pedido', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Converter em Pedido?');"><button type="submit" class="btn btn-xs btn-success" title="Converter"><i class="fas fa-check-circle"></i></button></form><a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-xs btn-info" title="Editar"><i class="fas fa-edit"></i></a><form action="{{ url_for('excluir_entrada', id=entrada.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem a certeza?');"><button type="submit" class="btn btn-xs btn-danger" title="Excluir"><i class="fas fa-trash-alt"></i></button></form></td>
            </tr>
            {% else %}
            <tr><td colspan="10" class="text-center">Nenhum orçamento encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block modals %}
    {# --- MODAL DE IMPORTAÇÃO (FORA DE QUALQUER LOOP) --- #}
    <div class="modal fade" id="importarEntradasModal" tabindex="-1" role="dialog" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importarModalLabel">Importar Entradas de .xlsx</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form action="{{ url_for('importar_entradas') }}" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <p>O seu ficheiro .xlsx deve ter as colunas na seguinte ordem, sem cabeçalho na primeira linha. As colunas com (*) são obrigatórias.</p>
                        <ul class="list-group mb-3">
                            <li class="list-group-item"><strong>Coluna A:</strong> N° Pedido (*)</li>
                            <li class="list-group-item"><strong>Coluna B:</strong> Tipo (Pedido ou Orçamento) (*)</li>
                            <li class="list-group-item"><strong>Coluna C:</strong> Nome do Cliente (*)</li>
                            <li class="list-group-item"><strong>Coluna D:</strong> Obra</li>
                            <li class="list-group-item"><strong>Coluna E:</strong> Status (Não iniciado, Em andamento, Concluído)</li>
                            <li class="list-group-item"><strong>Coluna F:</strong> Descrição (*)</li>
                            <li class="list-group-item"><strong>Coluna G:</strong> Observações</li>
                        </ul>
                        <div class="form-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="xlsx_file" name="xlsx_file" accept=".xlsx" required>
                                <label class="custom-file-label" for="xlsx_file">Escolher ficheiro...</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Importar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# --- LOOP PRINCIPAL PARA GERAR MODAIS PARA CADA ENTRADA --- #}
    {% for entrada in pedidos + orcamentos %}
    
        {% if entrada.cliente %}
        <div class="modal fade" id="clienteDetalhesModal-{{ entrada.cliente.id }}" tabindex="-1" role="dialog" aria-labelledby="clienteModalLabel-{{ entrada.cliente.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="clienteModalLabel-{{ entrada.cliente.id }}">Detalhes de: {{ entrada.cliente.nome }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Dados Pessoais</h6><hr class="mt-1 mb-2">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">N° Cliente:</dt><dd class="col-sm-8">{{ entrada.cliente.numero_cliente }}</dd>
                                    <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.nome }}</dd>
                                    <dt class="col-sm-4">Telefone:</dt><dd class="col-sm-8">{{ entrada.cliente.telefone or '-' }}</dd>
                                    <dt class="col-sm-4">Tipo Pessoa:</dt><dd class="col-sm-8">{{ entrada.cliente.tipo_pessoa }}</dd>
                                    <dt class="col-sm-4">CPF/CNPJ:</dt><dd class="col-sm-8">{{ entrada.cliente.cpf_cnpj or '-' }}</dd>
                                    <dt class="col-sm-4">Como Conheceu:</dt><dd class="col-sm-8">{{ entrada.cliente.como_conheceu or '-' }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6>Endereço</h6><hr class="mt-1 mb-2">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Rua:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.rua or '-' }}</dd>
                                    <dt class="col-sm-4">Número:</dt><dd class="col-sm-8">{{ entrada.cliente.numero_endereco or '-' }}</dd>
                                    <dt class="col-sm-4">Complemento:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.complemento or '-' }}</dd>
                                    <dt class="col-sm-4">Bairro:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.bairro or '-' }}</dd>
                                    <dt class="col-sm-4">Cidade:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.cidade or '-' }}</dd>
                                    <dt class="col-sm-4">UF:</dt><dd class="col-sm-8 text-uppercase">{{ entrada.cliente.uf or '-' }}</dd>
                                    <dt class="col-sm-4">CEP:</dt><dd class="col-sm-8">{{ entrada.cliente.cep or '-' }}</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Observações</h6><hr class="mt-1 mb-2">
                                <p style="white-space: pre-wrap;">{{ entrada.cliente.observacoes or 'Nenhuma observação.' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <a href="{{ url_for('editar_cliente', id=entrada.cliente.id) }}" class="btn btn-primary">Editar Cliente</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="modal fade" id="detalhesModal-{{ entrada.id }}" tabindex="-1" role="dialog" aria-labelledby="detalhesModalLabel-{{ entrada.id }}" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detalhesModalLabel-{{ entrada.id }}">Detalhes do {{ entrada.tipo }} #{{ entrada.numero_pedido }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-primary"></i> Informações Gerais</h6><hr class="mt-1">
                                <dl class="row">
                                    <dt class="col-sm-5">N° da Entrada</dt><dd class="col-sm-7">{{ entrada.numero_pedido }}</dd>
                                    <dt class="col-sm-5">Tipo</dt><dd class="col-sm-7">{{ entrada.tipo }}</dd>
                                    <dt class="col-sm-5">Data de Registo</dt><dd class="col-sm-7">{{ entrada.data_registro.strftime('%d/%m/%Y às %H:%M') }}</dd>
                                    <dt class="col-sm-5">Cliente</dt><dd class="col-sm-7 text-uppercase">{% if entrada.cliente %}{{ entrada.cliente.nome }}{% else %}{{ entrada.cliente_nome_temp }}{% endif %}</dd>
                                    <dt class="col-sm-5">Status</dt><dd class="col-sm-7">{% set status_color = 'secondary' %}{% if entrada.status == 'Concluído' %}{% set status_color = 'success' %}{% elif entrada.status == 'Em andamento' %}{% set status_color = 'warning' %}{% elif entrada.status == 'Não iniciado' %}{% set status_color = 'danger' %}{% endif %}<span class="badge badge-{{ status_color }}">{{ entrada.status }}</span></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-hard-hat text-primary"></i> Obra</h6><hr class="mt-1">
                                <p class="text-uppercase">{{ entrada.obra or 'Não especificada' }}</p>

                                <h6 class="mt-4"><i class="fas fa-paperclip text-primary"></i> Anexos</h6><hr class="mt-1">
                                <p class="text-muted small">Total de {{ entrada.anexos|length }} anexo(s).</p>
                                <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-plus"></i> Gerir Anexos</a>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="fas fa-align-left text-primary"></i> Descrição</h6><hr class="mt-1">
                                <p class="text-uppercase" style="white-space: pre-wrap;">{{ (entrada.descricao or '') }}</p>
                                <h6 class="mt-3"><i class="fas fa-comment-alt text-primary"></i> Observações</h6><hr class="mt-1">
                                <p class="text-uppercase" style="white-space: pre-wrap;">{{ entrada.observacoes or 'Nenhuma observação.' }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('editar_entrada', id=entrada.id) }}" class="btn btn-info"><i class="fas fa-edit"></i> Editar</a>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        {% if entrada.anexos %}
            <div class="modal fade" id="galeriaAnexos-{{ entrada.id }}" tabindex="-1" aria-labelledby="modalLabel-{{ entrada.id }}" aria-hidden="true">
                <div class="modal-dialog" style="max-width: none; width: 100vw; height: 100vh; margin: 0;">
                    <div class="modal-content" style="height: 100%; border: 0; border-radius: 0;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel-{{ entrada.id }}">Anexos de: {{ entrada.tipo }} #{{ entrada.numero_pedido }}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body p-0" style="flex-grow: 1;">
                            <div id="carouselAnexos-{{ entrada.id }}" class="carousel slide h-100" data-ride="carousel" data-interval="false">
                                <ol class="carousel-indicators">
                                    {% for _ in entrada.anexos %}
                                        <li data-target="#carouselAnexos-{{ entrada.id }}" data-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}"></li>
                                    {% endfor %}
                                </ol>
                                <div class="carousel-inner h-100">
                                    {% for anexo in entrada.anexos %}
                                    <div class="carousel-item text-center h-100 {% if loop.first %}active{% endif %}">
                                        {% if anexo.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')) %}
                                            <div class="d-flex justify-content-center align-items-center h-100" style="background-color: #343a40;">
                                                <img src="{{ url_for('uploaded_file', filename=anexo.filename) }}" style="object-fit: contain; max-width: 100%; max-height: 100%;" alt="{{ anexo.filename }}">
                                            </div>
                                        {% elif anexo.filename.lower().endswith('.pdf') %}
                                            <iframe src="{{ url_for('uploaded_file', filename=anexo.filename) }}" width="100%" height="100%" style="border: none;"></iframe>
                                        {% else %}
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <div class="text-center">
                                                    <i class="fas fa-file-alt fa-10x text-muted"></i>
                                                    <p class="mt-3">Não é possível pré-visualizar.</p>
                                                    <a href="{{ url_for('uploaded_file', filename=anexo.filename) }}" class="btn btn-primary" target="_blank">Descarregar</a>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if entrada.anexos|length > 1 %}
                                <a class="carousel-control-prev" href="#carouselAnexos-{{ entrada.id }}" role="button" data-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%;"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="carousel-control-next" href="#carouselAnexos-{{ entrada.id }}" role="button" data-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%;"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    {% endfor %}

{% endblock %}

{% block scripts %}
    <script>
    document.addEventListener('DOMContentLoaded',function(){
        // Script para atualização de status em tempo real
        const statusOptions = document.querySelectorAll('.status-option');
        const colorMap = {
            'Não iniciado': 'btn-danger',
            'Em andamento': 'btn-warning',
            'Concluído': 'btn-success'
        };

        statusOptions.forEach(option => {
            option.addEventListener('click', function(event) {
                event.preventDefault();
                const entryId = this.dataset.id;
                const newStatus = this.dataset.status;

                const xhr = new XMLHttpRequest();
                xhr.open('POST', `/atualizar-status/${entryId}`, true);
                xhr.setRequestHeader('Content-Type', 'application/json');

                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            // 1. Atualiza o botão de status na tabela
                            const button = document.getElementById(`status-btn-${entryId}`);
                            if (button) {
                                button.textContent = newStatus;
                                button.classList.remove('btn-danger', 'btn-warning', 'btn-success', 'btn-secondary');
                                button.classList.add(colorMap[newStatus] || 'btn-secondary');
                            }

                            // 2. Atualiza o dashboard de Pedidos
                            const dashPedidos = data.dashboard.pedidos;
                            document.getElementById('dash-pedidos-total').textContent = dashPedidos.total;
                            document.getElementById('dash-pedidos-nao-iniciado').textContent = dashPedidos.nao_iniciado;
                            document.getElementById('dash-pedidos-em-andamento').textContent = dashPedidos.em_andamento;
                            document.getElementById('dash-pedidos-concluido').textContent = dashPedidos.concluido;

                            // 3. Atualiza o dashboard de Orçamentos
                            const dashOrcamentos = data.dashboard.orcamentos;
                            document.getElementById('dash-orcamentos-total').textContent = dashOrcamentos.total;
                            document.getElementById('dash-orcamentos-nao-iniciado').textContent = dashOrcamentos.nao_iniciado;
                            document.getElementById('dash-orcamentos-em-andamento').textContent = dashOrcamentos.em_andamento;
                            document.getElementById('dash-orcamentos-concluido').textContent = dashOrcamentos.concluido;

                        } else {
                            alert('Erro ao atualizar o status: ' + data.message);
                        }
                    } else {
                        alert('Ocorreu um erro na resposta do servidor.');
                    }
                };

                xhr.onerror = function() {
                    alert('Ocorreu um erro de comunicação com o servidor.');
                };

                xhr.send(JSON.stringify({ status: newStatus }));
            });
        });

        // Script para atualização em tempo real (Socket.IO)
        var socket = io();
        socket.on('update_data', function(msg) {
            console.log('Update received!');
            // Apenas recarrega a página para mostrar os dados mais recentes
            location.reload();
        });
    });
    </script>
{% endblock %}